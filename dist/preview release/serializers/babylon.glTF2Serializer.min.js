<<<<<<< Updated upstream
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-serializers"]=t(require("babylonjs")):e.SERIALIZERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=13)}([function(t,r){t.exports=e},function(e,t,r){"use strict";r.d(t,"a",function(){return i});var n=r(0),i=function(){function e(){}return e._CreateBufferView=function(e,t,r,n,i){var a={buffer:e,byteLength:r};return t&&(a.byteOffset=t),i&&(a.name=i),n&&(a.byteStride=n),a},e._CreateAccessor=function(e,t,r,n,i,a,o,s){var l={name:t,bufferView:e,componentType:n,count:i,type:r};return null!=o&&(l.min=o),null!=s&&(l.max=s),null!=a&&(l.byteOffset=a),l},e._CalculateMinMaxPositions=function(t,r,i,a){var o,s,l,u=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];if(i)for(var f=r,h=r+i;f<h;++f){o=3*f,s=n.Vector3.FromArray(t,o),a&&e._GetRightHandedPositionVector3FromRef(s),l=s.asArray();for(var p=0;p<3;++p){var d=l[p];d<u[p]&&(u[p]=d),d>c[p]&&(c[p]=d),++o}}return{min:u,max:c}},e._GetRightHandedPositionVector3=function(e){return new n.Vector3(e.x,e.y,-e.z)},e._GetRightHandedPositionVector3FromRef=function(e){e.z*=-1},e._GetRightHandedPositionArray3FromRef=function(e){e[2]*=-1},e._GetRightHandedNormalVector3=function(e){return new n.Vector3(e.x,e.y,-e.z)},e._GetRightHandedNormalVector3FromRef=function(e){e.z*=-1},e._GetRightHandedNormalArray3FromRef=function(e){e[2]*=-1},e._GetRightHandedVector4FromRef=function(e){e.z*=-1,e.w*=-1},e._GetRightHandedArray4FromRef=function(e){e[2]*=-1,e[3]*=-1},e._GetRightHandedQuaternionFromRef=function(e){e.x*=-1,e.y*=-1},e._GetRightHandedQuaternionArrayFromRef=function(e){e[0]*=-1,e[1]*=-1},e._NormalizeTangentFromRef=function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)},e}()},function(e,t,r){"use strict";r.d(t,"b",function(){return l}),r.d(t,"a",function(){return u});var n=r(0),i=r(10),a=r(1),o=r(3),s=r(7),l=function(){function e(e,t){this._extensions={},this._glTF={asset:{generator:"BabylonJS",version:"2.0"}},this._babylonScene=e,this._bufferViews=[],this._accessors=[],this._meshes=[],this._scenes=[],this._nodes=[],this._images=[],this._materials=[],this._materialMap=[],this._textures=[],this._samplers=[],this._animations=[],this._imageData={},this._convertToRightHandedSystem=!this._babylonScene.useRightHandedSystem,this._options=t||{},this._animationSampleRate=t&&t.animationSampleRate?t.animationSampleRate:1/60,this._glTFMaterialExporter=new i.a(this),this._loadExtensions()}return e.prototype._applyExtensions=function(t,r){for(var n=0,i=e._ExtensionNames;n<i.length;n++){var a=i[n],o=this._extensions[a];if(o.enabled){var s=t;s._activeLoaderExtensions=s._activeLoaderExtensions||{};var l=s._activeLoaderExtensions;if(!l[a]){l[a]=!0;try{var u=r(o);if(u)return u}finally{delete l[a],delete s._activeLoaderExtensions}}}}return null},e.prototype._extensionsPreExportTextureAsync=function(e,t,r){return this._applyExtensions(t,function(n){return n.preExportTextureAsync&&n.preExportTextureAsync(e,t,r)})},e.prototype._extensionsPostExportMeshPrimitiveAsync=function(e,t,r,n){return this._applyExtensions(t,function(i){return i.postExportMeshPrimitiveAsync&&i.postExportMeshPrimitiveAsync(e,t,r,n)})},e.prototype._extensionsPostExportNodeAsync=function(e,t,r){return this._applyExtensions(t,function(n){return n.postExportNodeAsync&&n.postExportNodeAsync(e,t,r)})},e.prototype._forEachExtensions=function(t){for(var r=0,n=e._ExtensionNames;r<n.length;r++){var i=n[r],a=this._extensions[i];a.enabled&&t(a)}},e.prototype._extensionsOnExporting=function(){this._forEachExtensions(function(e){return e.onExporting&&e.onExporting()})},e.prototype._loadExtensions=function(){for(var t=0,r=e._ExtensionNames;t<r.length;t++){var n=r[t],i=e._ExtensionFactories[n](this);this._extensions[n]=i}},e.RegisterExtension=function(t,r){e.UnregisterExtension(t)&&n.Tools.Warn("Extension with the name "+t+" already exists"),e._ExtensionFactories[t]=r,e._ExtensionNames.push(t)},e.UnregisterExtension=function(t){if(!e._ExtensionFactories[t])return!1;delete e._ExtensionFactories[t];var r=e._ExtensionNames.indexOf(t);return-1!==r&&e._ExtensionNames.splice(r,1),!0},e.prototype._getLocalEngine=function(){if(!this._localEngine){var e=document.createElement("canvas");e.id="WriteCanvas",e.width=2048,e.height=2048,this._localEngine=new n.Engine(e,!0,{premultipliedAlpha:!1,preserveDrawingBuffer:!0}),this._localEngine.setViewport(new n.Viewport(0,0,1,1))}return this._localEngine},e.prototype.reorderIndicesBasedOnPrimitiveMode=function(e,t,r,i,a){switch(t){case n.Material.TriangleFillMode:i||(i=0);for(var o=e.indexStart,s=e.indexStart+e.indexCount;o<s;o+=3){var l=i+4*o,u=a.getUInt32(l+4),c=a.getUInt32(l+8);a.setUInt32(c,l+4),a.setUInt32(u,l+8)}break;case n.Material.TriangleFanDrawMode:o=e.indexStart+e.indexCount-1;for(var f=e.indexStart;o>=f;--o)a.setUInt32(r[o],i),i+=4;break;case n.Material.TriangleStripDrawMode:e.indexCount>=3&&(a.setUInt32(r[e.indexStart+2],i+4),a.setUInt32(r[e.indexStart+1],i+8))}},e.prototype.reorderVertexAttributeDataBasedOnPrimitiveMode=function(e,t,r,i,a,o,s){if(this._convertToRightHandedSystem&&r===n.Material.ClockWiseSideOrientation)switch(t){case n.Material.TriangleFillMode:this.reorderTriangleFillMode(e,t,r,i,a,o,s);break;case n.Material.TriangleStripDrawMode:this.reorderTriangleStripDrawMode(e,t,r,i,a,o,s);break;case n.Material.TriangleFanDrawMode:this.reorderTriangleFanMode(e,t,r,i,a,o,s)}},e.prototype.reorderTriangleFillMode=function(e,t,r,i,a,o,s){var l=this.getVertexBufferFromMesh(i,e.getMesh());if(l){var u=l.byteStride/n.VertexBuffer.GetTypeByteLength(l.type);if(e.verticesCount%3!=0)n.Tools.Error("The submesh vertices for the triangle fill mode is not divisible by 3!");else{var c=[],f=0;switch(i){case n.VertexBuffer.PositionKind:case n.VertexBuffer.NormalKind:for(var h=e.verticesStart;h<e.verticesStart+e.verticesCount;h+=3)f=h*u,c.push(n.Vector3.FromArray(a,f)),c.push(n.Vector3.FromArray(a,f+2*u)),c.push(n.Vector3.FromArray(a,f+u));break;case n.VertexBuffer.TangentKind:for(h=e.verticesStart;h<e.verticesStart+e.verticesCount;h+=3)f=h*u,c.push(n.Vector4.FromArray(a,f)),c.push(n.Vector4.FromArray(a,f+2*u)),c.push(n.Vector4.FromArray(a,f+u));break;case n.VertexBuffer.ColorKind:var p=l.getSize();for(h=e.verticesStart;h<e.verticesStart+e.verticesCount;h+=p)f=h*u,4===p?(c.push(n.Vector4.FromArray(a,f)),c.push(n.Vector4.FromArray(a,f+2*u)),c.push(n.Vector4.FromArray(a,f+u))):(c.push(n.Vector3.FromArray(a,f)),c.push(n.Vector3.FromArray(a,f+2*u)),c.push(n.Vector3.FromArray(a,f+u)));break;case n.VertexBuffer.UVKind:case n.VertexBuffer.UV2Kind:for(h=e.verticesStart;h<e.verticesStart+e.verticesCount;h+=3)f=h*u,c.push(n.Vector2.FromArray(a,f)),c.push(n.Vector2.FromArray(a,f+2*u)),c.push(n.Vector2.FromArray(a,f+u));break;default:n.Tools.Error("Unsupported Vertex Buffer type: "+i)}this.writeVertexAttributeData(c,o,i,a,s)}}else n.Tools.Warn("reorderTriangleFillMode: Vertex Buffer Kind "+i+" not present!")},e.prototype.reorderTriangleStripDrawMode=function(e,t,r,i,a,o,s){var l=this.getVertexBufferFromMesh(i,e.getMesh());if(l){var u=l.byteStride/n.VertexBuffer.GetTypeByteLength(l.type),c=[],f=0;switch(i){case n.VertexBuffer.PositionKind:case n.VertexBuffer.NormalKind:f=e.verticesStart,c.push(n.Vector3.FromArray(a,f+2*u)),c.push(n.Vector3.FromArray(a,f+u));break;case n.VertexBuffer.TangentKind:for(var h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*u,c.push(n.Vector4.FromArray(a,f));break;case n.VertexBuffer.ColorKind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*u,4===l.getSize()?c.push(n.Vector4.FromArray(a,f)):c.push(n.Vector3.FromArray(a,f));break;case n.VertexBuffer.UVKind:case n.VertexBuffer.UV2Kind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*u,c.push(n.Vector2.FromArray(a,f));break;default:n.Tools.Error("Unsupported Vertex Buffer type: "+i)}this.writeVertexAttributeData(c,o+12,i,a,s)}else n.Tools.Warn("reorderTriangleStripDrawMode: Vertex buffer kind "+i+" not present!")},e.prototype.reorderTriangleFanMode=function(e,t,r,i,a,o,s){var l=this.getVertexBufferFromMesh(i,e.getMesh());if(l){var u=l.byteStride/n.VertexBuffer.GetTypeByteLength(l.type),c=[],f=0;switch(i){case n.VertexBuffer.PositionKind:case n.VertexBuffer.NormalKind:for(var h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*u,c.push(n.Vector3.FromArray(a,f));break;case n.VertexBuffer.TangentKind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*u,c.push(n.Vector4.FromArray(a,f));break;case n.VertexBuffer.ColorKind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*u,c.push(n.Vector4.FromArray(a,f)),4===l.getSize()?c.push(n.Vector4.FromArray(a,f)):c.push(n.Vector3.FromArray(a,f));break;case n.VertexBuffer.UVKind:case n.VertexBuffer.UV2Kind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*u,c.push(n.Vector2.FromArray(a,f));break;default:n.Tools.Error("Unsupported Vertex Buffer type: "+i)}this.writeVertexAttributeData(c,o,i,a,s)}else n.Tools.Warn("reorderTriangleFanMode: Vertex buffer kind "+i+" not present!")},e.prototype.writeVertexAttributeData=function(e,t,r,i,o){for(var s=0,l=e;s<l.length;s++){var u=l[s];!this._convertToRightHandedSystem||r===n.VertexBuffer.ColorKind||u instanceof n.Vector2||(u instanceof n.Vector3?r===n.VertexBuffer.NormalKind?a.a._GetRightHandedNormalVector3FromRef(u):r===n.VertexBuffer.PositionKind?a.a._GetRightHandedPositionVector3FromRef(u):n.Tools.Error("Unsupported vertex attribute kind!"):a.a._GetRightHandedVector4FromRef(u)),r===n.VertexBuffer.NormalKind?u.normalize():r===n.VertexBuffer.TangentKind&&u instanceof n.Vector4&&a.a._NormalizeTangentFromRef(u);for(var c=0,f=u.asArray();c<f.length;c++){var h=f[c];o.setFloat32(h,t),t+=4}}},e.prototype.writeAttributeData=function(e,t,r,i){var o,s=r/4,l=[];switch(e){case n.VertexBuffer.PositionKind:for(var u=0,c=t.length/s;u<c;++u){o=u*s;var f=n.Vector3.FromArray(t,o);this._convertToRightHandedSystem&&a.a._GetRightHandedPositionVector3FromRef(f),l.push(f.asArray())}break;case n.VertexBuffer.NormalKind:u=0;for(var h=t.length/s;u<h;++u){o=u*s;f=n.Vector3.FromArray(t,o);this._convertToRightHandedSystem&&a.a._GetRightHandedNormalVector3FromRef(f),f.normalize(),l.push(f.asArray())}break;case n.VertexBuffer.TangentKind:u=0;for(var p=t.length/s;u<p;++u){o=u*s;f=n.Vector4.FromArray(t,o);this._convertToRightHandedSystem&&a.a._GetRightHandedVector4FromRef(f),a.a._NormalizeTangentFromRef(f),l.push(f.asArray())}break;case n.VertexBuffer.ColorKind:u=0;for(var d=t.length/s;u<d;++u){o=u*s;f=3===s?n.Vector3.FromArray(t,o):n.Vector4.FromArray(t,o);l.push(f.asArray())}break;case n.VertexBuffer.UVKind:case n.VertexBuffer.UV2Kind:u=0;for(var m=t.length/s;u<m;++u)o=u*s,l.push((this._convertToRightHandedSystem,[t[o],t[o+1]]));break;default:n.Tools.Warn("Unsupported Vertex Buffer Type: "+e),l=[]}for(var g=0,_=l;g<_.length;g++)for(var y=0,x=_[g];y<x.length;y++){var T=x[y];i.setFloat32(T)}},e.prototype.generateJSON=function(e,t,r){var n,i,o,s=this,l={byteLength:this._totalByteLength},u=this._totalByteLength;return l.byteLength&&(this._glTF.buffers=[l]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._images&&this._images.length&&(e?(this._glTF.images=[],this._images.forEach(function(e){e.uri&&(i=s._imageData[e.uri],n=e.uri.split(".")[0]+" image",o=a.a._CreateBufferView(0,u,i.data.length,void 0,n),u+=i.data.buffer.byteLength,s._bufferViews.push(o),e.bufferView=s._bufferViews.length-1,e.name=n,e.mimeType=i.mimeType,e.uri=void 0,s._glTF.images||(s._glTF.images=[]),s._glTF.images.push(e))}),l.byteLength=u):this._glTF.images=this._images),e||(l.uri=t+".bin"),r?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)},e.prototype._generateGLTFAsync=function(e){var t=this;return this._generateBinaryAsync().then(function(r){t._extensionsOnExporting();var n=t.generateJSON(!1,e,!0),i=new Blob([r],{type:"application/octet-stream"}),a=e+".gltf",s=e+".bin",l=new o.GLTFData;if(l.glTFFiles[a]=n,l.glTFFiles[s]=i,t._imageData)for(var u in t._imageData)l.glTFFiles[u]=new Blob([t._imageData[u].data],{type:t._imageData[u].mimeType});return l})},e.prototype._generateBinaryAsync=function(){var e=this,t=new u(4);return this.createSceneAsync(this._babylonScene,t).then(function(){return e._localEngine&&e._localEngine.dispose(),t.getArrayBuffer()})},e.prototype._getPadding=function(e){var t=e%4;return 0===t?t:4-t},e.prototype._generateGLBAsync=function(e){var t=this;return this._generateBinaryAsync().then(function(r){t._extensionsOnExporting();var n=t.generateJSON(!0),i=e+".glb",a=n.length,s=0;for(var l in t._imageData)s+=t._imageData[l].data.byteLength;var u=t._getPadding(a),c=t._getPadding(r.byteLength),f=t._getPadding(s),h=28+a+u+r.byteLength+c+s+f,p=new ArrayBuffer(12),d=new DataView(p);d.setUint32(0,1179937895,!0),d.setUint32(4,2,!0),d.setUint32(8,h,!0);var m=new ArrayBuffer(8+a+u),g=new DataView(m);g.setUint32(0,a+u,!0),g.setUint32(4,1313821514,!0);for(var _=new Uint8Array(m,8),y=0;y<a;++y)_[y]=n.charCodeAt(y);var x=new Uint8Array(m,8+a);for(y=0;y<u;++y)x[y]=32;var T=new ArrayBuffer(8),v=new DataView(T);v.setUint32(0,r.byteLength+s+f,!0),v.setUint32(4,5130562,!0);var A=new ArrayBuffer(c),b=new Uint8Array(A);for(y=0;y<c;++y)b[y]=0;var F=new ArrayBuffer(f),E=new Uint8Array(F);for(y=0;y<f;++y)E[y]=0;var R=[p,m,T,r];for(var l in t._imageData)R.push(t._imageData[l].data.buffer);R.push(A),R.push(F);var S=new Blob(R,{type:"application/octet-stream"}),M=new o.GLTFData;return M.glTFFiles[i]=S,null!=t._localEngine&&t._localEngine.dispose(),M})},e.prototype.setNodeTransformation=function(e,t){t.getPivotPoint().equalsToFloats(0,0,0)||n.Tools.Warn("Pivot points are not supported in the glTF serializer"),t.position.equalsToFloats(0,0,0)||(e.translation=this._convertToRightHandedSystem?a.a._GetRightHandedPositionVector3(t.position).asArray():t.position.asArray()),t.scaling.equalsToFloats(1,1,1)||(e.scale=t.scaling.asArray());var r=n.Quaternion.RotationYawPitchRoll(t.rotation.y,t.rotation.x,t.rotation.z);t.rotationQuaternion&&r.multiplyInPlace(t.rotationQuaternion),0===r.x&&0===r.y&&0===r.z&&1===r.w||(this._convertToRightHandedSystem&&a.a._GetRightHandedQuaternionFromRef(r),e.rotation=r.normalize().asArray())},e.prototype.getVertexBufferFromMesh=function(e,t){if(t.isVerticesDataPresent(e)){var r=t.getVertexBuffer(e);if(r)return r}return null},e.prototype.createBufferViewKind=function(e,t,r,i){var o=t instanceof n.Mesh?t:t instanceof n.InstancedMesh?t.sourceMesh:null;if(o){var s=o.getVerticesData(e);if(s){var l=4*s.length,u=a.a._CreateBufferView(0,r.getByteOffset(),l,i,e+" - "+o.name);this._bufferViews.push(u),this.writeAttributeData(e,s,i,r)}}},e.prototype.getMeshPrimitiveMode=function(e){return e instanceof n.LinesMesh?n.Material.LineListDrawMode:e.material?e.material.fillMode:n.Material.TriangleFillMode},e.prototype.setPrimitiveMode=function(e,t){switch(t){case n.Material.TriangleFillMode:break;case n.Material.TriangleStripDrawMode:e.mode=5;break;case n.Material.TriangleFanDrawMode:e.mode=6;break;case n.Material.PointListDrawMode:e.mode=0;case n.Material.PointFillMode:e.mode=0;break;case n.Material.LineLoopDrawMode:e.mode=2;break;case n.Material.LineListDrawMode:e.mode=1;break;case n.Material.LineStripDrawMode:e.mode=3}},e.prototype.setAttributeKind=function(e,t){switch(t){case n.VertexBuffer.PositionKind:e.attributes.POSITION=this._accessors.length-1;break;case n.VertexBuffer.NormalKind:e.attributes.NORMAL=this._accessors.length-1;break;case n.VertexBuffer.ColorKind:e.attributes.COLOR_0=this._accessors.length-1;break;case n.VertexBuffer.TangentKind:e.attributes.TANGENT=this._accessors.length-1;break;case n.VertexBuffer.UVKind:e.attributes.TEXCOORD_0=this._accessors.length-1;break;case n.VertexBuffer.UV2Kind:e.attributes.TEXCOORD_1=this._accessors.length-1;break;default:n.Tools.Warn("Unsupported Vertex Buffer Type: "+t)}},e.prototype.setPrimitiveAttributesAsync=function(e,t,r){var i,o,s=[],l=null;t instanceof n.Mesh?l=t:t instanceof n.InstancedMesh&&(l=t.sourceMesh);var u=[{kind:n.VertexBuffer.PositionKind,accessorType:"VEC3",byteStride:12},{kind:n.VertexBuffer.NormalKind,accessorType:"VEC3",byteStride:12},{kind:n.VertexBuffer.ColorKind,accessorType:"VEC4",byteStride:16},{kind:n.VertexBuffer.TangentKind,accessorType:"VEC4",byteStride:16},{kind:n.VertexBuffer.UVKind,accessorType:"VEC2",byteStride:8},{kind:n.VertexBuffer.UV2Kind,accessorType:"VEC2",byteStride:8}];if(l){for(var c=null,f=this.getMeshPrimitiveMode(l),h={},p=0,d=u;p<d.length;p++){var m=(k=d[p]).kind;if(l.isVerticesDataPresent(m)){var g=this.getVertexBufferFromMesh(m,l);k.byteStride=g?4*g.getSize():4*n.VertexBuffer.DeduceStride(m),12===k.byteStride&&(k.accessorType="VEC3"),this.createBufferViewKind(m,t,r,k.byteStride),k.bufferViewIndex=this._bufferViews.length-1,h[m]=k.bufferViewIndex}}if(l.getTotalIndices()){var _=l.getIndices();if(_){var y=4*_.length;i=a.a._CreateBufferView(0,r.getByteOffset(),y,void 0,"Indices - "+l.name),this._bufferViews.push(i),c=this._bufferViews.length-1;for(var x=0,T=_.length;x<T;++x)r.setUInt32(_[x])}}if(l.subMeshes)for(var v=0,A=l.subMeshes;v<A.length;v++){var b=A[v],F=b.getMaterial()||l.getScene().defaultMaterial,E=null;if(F)if(l instanceof n.LinesMesh){var R={name:l.name+" material"};(!l.color.equals(n.Color3.White())||l.alpha<1)&&(R.pbrMetallicRoughness={baseColorFactor:l.color.asArray().concat([l.alpha])}),this._materials.push(R),E=this._materials.length-1}else if(F instanceof n.MultiMaterial){var S=F.subMaterials[b.materialIndex];S&&(F=S,E=this._materialMap[F.uniqueId])}else E=this._materialMap[F.uniqueId];var M=null!=E?this._materials[E]:null,V={attributes:{}};this.setPrimitiveMode(V,f);for(var w=0,C=u;w<C.length;w++){if((m=(k=C[w]).kind)!==n.VertexBuffer.UVKind&&m!==n.VertexBuffer.UV2Kind||!M||this._glTFMaterialExporter._hasTexturesPresent(M))if(U=l.getVerticesData(m))if(g=this.getVertexBufferFromMesh(m,l)){var B=g.getSize(),P=k.bufferViewIndex;if(null!=P){o={min:null,max:null},m==n.VertexBuffer.PositionKind&&(o=a.a._CalculateMinMaxPositions(U,0,U.length/B,this._convertToRightHandedSystem));var L=a.a._CreateAccessor(P,m+" - "+t.name,k.accessorType,5126,U.length/B,0,o.min,o.max);this._accessors.push(L),this.setAttributeKind(V,m)}}}if(c){L=a.a._CreateAccessor(c,"indices - "+t.name,"SCALAR",5125,b.indexCount,4*b.indexStart,null,null);this._accessors.push(L),V.indices=this._accessors.length-1}if(null!=E&&Object.keys(V.attributes).length>0){var N=null!==l.overrideMaterialSideOrientation?l.overrideMaterialSideOrientation:F.sideOrientation;if(N===n.Material.ClockWiseSideOrientation){var I=null!=c?this._bufferViews[c].byteOffset:null;null==I&&(I=0);var G=null;if(null!=c&&(G=l.getIndices()),G)this.reorderIndicesBasedOnPrimitiveMode(b,f,G,I,r);else for(var O=0,D=u;O<D.length;O++){var U,k=D[O];if(U=l.getVerticesData(k.kind)){var K=this._bufferViews[h[k.kind]].byteOffset;K||(K=0),this.reorderVertexAttributeDataBasedOnPrimitiveMode(b,f,N,k.kind,U,K,r)}}}V.material=E}e.primitives.push(V),this._extensionsPostExportMeshPrimitiveAsync("postExport",V,b,r)&&s.push()}}return Promise.all(s).then(function(){})},e.prototype.createSceneAsync=function(e,t){var r,i,a,o=this,s={nodes:[]},l=e.transformNodes.concat(e.meshes,e.lights);return this._glTFMaterialExporter._convertMaterialsToGLTFAsync(e.materials,"image/png",!0).then(function(){return o.createNodeMapAndAnimationsAsync(e,l,t).then(function(e){if(o._nodeMap=e,o._totalByteLength=t.getByteOffset(),null==o._totalByteLength)throw new Error("undefined byte length!");for(var u=0,c=l;u<c.length;u++){var f=c[u];if(void 0!==(r=o._nodeMap[f.uniqueId])&&(i=o._nodes[r],f.metadata&&(o._options.metadataSelector?i.extras=o._options.metadataSelector(f.metadata):f.metadata.gltf&&(i.extras=f.metadata.gltf.extras)),f.parent||(o._options.shouldExportNode&&!o._options.shouldExportNode(f)?n.Tools.Log("Omitting "+f.name+" from scene."):(o._convertToRightHandedSystem&&(i.translation&&(i.translation[2]*=-1,i.translation[0]*=-1),i.rotation=i.rotation?n.Quaternion.FromArray([0,1,0,0]).multiply(n.Quaternion.FromArray(i.rotation)).asArray():n.Quaternion.FromArray([0,1,0,0]).asArray()),s.nodes.push(r))),a=f.getDescendants(!0),!i.children&&a&&a.length)){for(var h=[],p=0,d=a;p<d.length;p++){var m=d[p];null!=o._nodeMap[m.uniqueId]&&h.push(o._nodeMap[m.uniqueId])}h.length&&(i.children=h)}}s.nodes.length&&o._scenes.push(s)})})},e.prototype.createNodeMapAndAnimationsAsync=function(e,t,r){for(var i,a=this,o=Promise.resolve(),l={},u={name:"runtime animations",channels:[],samplers:[]},c=[],f=function(t){!h._options.shouldExportNode||h._options.shouldExportNode(t)?o=o.then(function(){return a.createNodeAsync(t,r).then(function(o){var f=a._extensionsPostExportNodeAsync("createNodeAsync",o,t);return null==f?(n.Tools.Warn("Not exporting node "+t.name),Promise.resolve()):f.then(function(o){(t.getDescendants(!0,function(e){return e instanceof n.Node}).length||null!=o.mesh||o.extensions)&&(a._nodes.push(o),i=a._nodes.length-1,l[t.uniqueId]=i),!e.animationGroups.length&&t.animations.length&&s.a._CreateNodeAnimationFromNodeAnimations(t,u,c,l,a._nodes,r,a._bufferViews,a._accessors,a._convertToRightHandedSystem,a._animationSampleRate)})})}):t.name},h=this,p=0,d=t;p<d.length;p++){f(d[p])}return o.then(function(){return u.channels.length&&u.samplers.length&&a._animations.push(u),c.forEach(function(e){e.channels.length&&e.samplers.length&&a._animations.push(e)}),e.animationGroups.length&&s.a._CreateNodeAnimationFromAnimationGroups(e,a._animations,l,a._nodes,r,a._bufferViews,a._accessors,a._convertToRightHandedSystem,a._animationSampleRate),l})},e.prototype.createNodeAsync=function(e,t){var r=this;return Promise.resolve().then(function(){var i={},a={primitives:[]};return e.name&&(i.name=e.name),e instanceof n.TransformNode?(r.setNodeTransformation(i,e),r.setPrimitiveAttributesAsync(a,e,t).then(function(){return a.primitives.length&&(r._meshes.push(a),i.mesh=r._meshes.length-1),i})):i})},e._ExtensionNames=new Array,e._ExtensionFactories={},e}(),u=function(){function e(e){this._arrayBuffer=new ArrayBuffer(e),this._dataView=new DataView(this._arrayBuffer),this._byteOffset=0}return e.prototype.resizeBuffer=function(e){for(var t=new ArrayBuffer(e),r=new Uint8Array(this._arrayBuffer),n=new Uint8Array(t),i=0,a=n.byteLength;i<a;++i)n[i]=r[i];return this._arrayBuffer=t,this._dataView=new DataView(this._arrayBuffer),t},e.prototype.getArrayBuffer=function(){return this.resizeBuffer(this.getByteOffset())},e.prototype.getByteOffset=function(){if(null==this._byteOffset)throw new Error("Byte offset is undefined!");return this._byteOffset},e.prototype.setUInt8=function(e,t){null!=t?t<this._byteOffset?this._dataView.setUint8(t,e):n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint8(this._byteOffset++,e))},e.prototype.getUInt32=function(e){if(e<this._byteOffset)return this._dataView.getUint32(e,!0);throw n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"),new Error("BinaryWriter: byteoffset is greater than the current binary buffer length!")},e.prototype.getVector3Float32FromRef=function(e,t){t+8>this._byteOffset?n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0))},e.prototype.setVector3Float32FromRef=function(e,t){t+8>this._byteOffset?n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0))},e.prototype.getVector4Float32FromRef=function(e,t){t+12>this._byteOffset?n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0),e.w=this._dataView.getFloat32(t+12,!0))},e.prototype.setVector4Float32FromRef=function(e,t){t+12>this._byteOffset?n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0),this._dataView.setFloat32(t+12,e.w,!0))},e.prototype.setFloat32=function(e,t){isNaN(e)&&n.Tools.Error("Invalid data being written!"),null!=t&&(t<this._byteOffset?this._dataView.setFloat32(t,e,!0):n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary length!")),this._byteOffset+4>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.setUInt32=function(e,t){null!=t?t<this._byteOffset?this._dataView.setUint32(t,e,!0):n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+4>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4)},e}()},function(e,t,r){"use strict";r.r(t),r.d(t,"GLTFData",function(){return n});var n=function(){function e(){this.glTFFiles={}}return e.prototype.downloadFiles=function(){function e(e,t){return-1!==e.indexOf(t,e.length-t.length)}for(var t in this.glTFFiles){var r=document.createElement("a");document.body.appendChild(r),r.setAttribute("type","hidden"),r.download=t;var n=this.glTFFiles[t],i=void 0;e(t,".glb")?i={type:"model/gltf-binary"}:e(t,".bin")?i={type:"application/octet-stream"}:e(t,".gltf")?i={type:"model/gltf+json"}:e(t,".jpeg")?i={type:"image/jpeg"}:e(t,".png")&&(i={type:"image/png"}),r.href=window.URL.createObjectURL(new Blob([n],i)),r.click()}},e}()},function(e,t,r){"use strict";r.r(t),r.d(t,"__IGLTFExporterExtension",function(){return n});var n=0},,function(e,t,r){"use strict";r.r(t);var n=r(7),i=r(3),a=r(2),o=r(10),s=r(8),l=r(1),u=r(9);r.d(t,"_GLTFAnimation",function(){return n.a}),r.d(t,"GLTFData",function(){return i.GLTFData}),r.d(t,"_Exporter",function(){return a.b}),r.d(t,"_BinaryWriter",function(){return a.a}),r.d(t,"__IGLTFExporterExtensionV2",function(){return 0}),r.d(t,"_GLTFMaterialExporter",function(){return o.a}),r.d(t,"GLTF2Export",function(){return s.GLTF2Export}),r.d(t,"_GLTFUtilities",function(){return l.a}),r.d(t,"KHR_texture_transform",function(){return u.KHR_texture_transform}),r.d(t,"KHR_lights_punctual",function(){return u.KHR_lights_punctual})},function(e,t,r){"use strict";r.d(t,"a",function(){return o});var n,i=r(0),a=r(1);!function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"}(n||(n={}));var o=function(){function e(){}return e._CreateNodeAnimation=function(t,r,n,a,o,s){var l=[],u=[],c=r.getKeys(),f=e.calculateMinMaxKeyFrames(c),h=e._DeduceInterpolation(c,n,o),p=f.max-f.min,d=h.interpolationType,m=h.shouldBakeAnimation;return m?e._CreateBakedAnimation(t,r,n,f.min,f.max,r.framePerSecond,s,l,u,f,a,o):"LINEAR"===d||"STEP"===d?e._CreateLinearOrStepAnimation(t,r,n,p,l,u,a,o):"CUBICSPLINE"===d?e._CreateCubicSplineAnimation(t,r,n,p,l,u,a,o):e._CreateBakedAnimation(t,r,n,f.min,f.max,r.framePerSecond,s,l,u,f,a,o),l.length&&u.length?{inputs:l,outputs:u,samplerInterpolation:d,inputsMin:m?f.min:i.Tools.FloatRound(f.min/r.framePerSecond),inputsMax:m?f.max:i.Tools.FloatRound(f.max/r.framePerSecond)}:null},e._DeduceAnimationInfo=function(e){var t=null,r="VEC3",n=!1,a=e.targetProperty.split(".");switch(a[0]){case"scaling":t="scale";break;case"position":t="translation";break;case"rotation":r="VEC4",t="rotation";break;case"rotationQuaternion":r="VEC4",n=!0,t="rotation";break;default:i.Tools.Error("Unsupported animatable property "+a[0])}return t?{animationChannelTargetPath:t,dataAccessorType:r,useQuaternion:n}:(i.Tools.Error("animation channel target path and data accessor type could be deduced"),null)},e._CreateNodeAnimationFromNodeAnimations=function(t,r,n,a,o,s,l,u,c,f){var h;if(t instanceof i.TransformNode&&t.animations)for(var p=0,d=t.animations;p<d.length;p++){var m=d[p],g=e._DeduceAnimationInfo(m);g&&(h={name:m.name,samplers:[],channels:[]},e.AddAnimation(""+m.name,m.hasRunningRuntimeAnimations?r:h,t,m,g.dataAccessorType,g.animationChannelTargetPath,a,s,l,u,c,g.useQuaternion,f),h.samplers.length&&h.channels.length&&n.push(h))}},e._CreateNodeAnimationFromAnimationGroups=function(t,r,n,a,o,s,l,u,c){var f;if(t.animationGroups)for(var h=0,p=t.animationGroups;h<p.length;h++){var d=p[h];f={name:d.name,channels:[],samplers:[]};for(var m=0,g=d.targetedAnimations;m<g.length;m++){var _=g[m],y=_.target,x=_.animation;if(y instanceof i.Mesh||1===y.length&&y[0]instanceof i.Mesh){var T=e._DeduceAnimationInfo(_.animation);if(T){var v=y instanceof i.Mesh?y:y[0];e.AddAnimation(""+x.name,f,v,x,T.dataAccessorType,T.animationChannelTargetPath,n,o,s,l,u,T.useQuaternion,c)}}}f.channels.length&&f.samplers.length&&r.push(f)}},e.AddAnimation=function(t,r,n,i,o,s,l,u,c,f,h,p,d){var m,g,_,y,x,T,v,A=e._CreateNodeAnimation(n,i,s,h,p,d);if(A){var b=l[n.uniqueId],F=4*A.inputs.length;m=a.a._CreateBufferView(0,u.getByteOffset(),F,void 0,t+"  keyframe data view"),c.push(m),A.inputs.forEach(function(e){u.setFloat32(e)}),g=a.a._CreateAccessor(c.length-1,t+"  keyframes","SCALAR",5126,A.inputs.length,null,[A.inputsMin],[A.inputsMax]),f.push(g),_=f.length-1,x=A.outputs.length,F="VEC3"===o?12*A.outputs.length:16*A.outputs.length,m=a.a._CreateBufferView(0,u.getByteOffset(),F,void 0,t+"  data view"),c.push(m),A.outputs.forEach(function(e){e.forEach(function(e){u.setFloat32(e)})}),g=a.a._CreateAccessor(c.length-1,t+"  data",o,5126,x,null,null,null),f.push(g),y=f.length-1,T={interpolation:A.samplerInterpolation,input:_,output:y},r.samplers.push(T),v={sampler:r.samplers.length-1,target:{node:b,path:s}},r.channels.push(v)}},e._CreateBakedAnimation=function(t,r,n,a,o,s,l,u,c,f,h,p){var d,m,g=i.Quaternion.Identity(),_=null,y=null,x=null,T=null,v=null,A=null;f.min=i.Tools.FloatRound(a/s);for(var b=r.getKeys(),F=0,E=b.length;F<E;++F){if(A=null,x=b[F],F+1<E)if(T=b[F+1],x.value.equals(T.value)){if(0!==F)continue;A=x.frame}else A=T.frame;else{if(v=b[F-1],x.value.equals(v.value))continue;A=o}if(A)for(var R=x.frame;R<=A;R+=l)if((m=i.Tools.FloatRound(R/s))!==_){_=m,y=m;var S={key:0,repeatCount:0,loopMode:r.loopMode};d=r._interpolate(R,S),e._SetInterpolatedValue(t,d,m,r,n,g,u,c,h,p)}}y&&(f.max=y)},e._ConvertFactorToVector3OrQuaternion=function(t,r,n,a,o,s,l){var u,c,f=null,h=e._GetBasePositionRotationOrScale(r,o,s,l);if(a===i.Animation.ANIMATIONTYPE_FLOAT)switch(c=(u=n.targetProperty.split("."))?u[1]:"",f=l?i.Quaternion.FromArray(h).normalize():i.Vector3.FromArray(h),c){case"x":case"y":f[c]=s&&l&&"scale"!==o?-t:t;break;case"z":f[c]=s&&!l&&"scale"!==o?-t:t;break;case"w":f.w=t;break;default:i.Tools.Error('glTFAnimation: Unsupported component type "'+c+'" for scale animation!')}return f},e._SetInterpolatedValue=function(e,t,r,n,o,s,l,u,c,f){var h,p=n.dataType;l.push(r),"number"==typeof t&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,n,p,o,c,f)),t&&("rotation"===o?(f?s=t:(h=t,i.Quaternion.RotationYawPitchRollToRef(h.y,h.x,h.z,s)),c&&(a.a._GetRightHandedQuaternionFromRef(s),e.parent||(s=i.Quaternion.FromArray([0,1,0,0]).multiply(s))),u.push(s.asArray())):(h=t,c&&"scale"!==o&&(a.a._GetRightHandedPositionVector3FromRef(h),e.parent||(h.x*=-1,h.z*=-1)),u.push(h.asArray())))},e._CreateLinearOrStepAnimation=function(t,r,n,i,a,o,s,l){for(var u=0,c=r.getKeys();u<c.length;u++){var f=c[u];a.push(f.frame/r.framePerSecond),e._AddKeyframeValue(f,r,o,n,t,s,l)}},e._CreateCubicSplineAnimation=function(t,r,i,a,o,s,l,u){r.getKeys().forEach(function(c){o.push(c.frame/r.framePerSecond),e.AddSplineTangent(t,n.INTANGENT,s,i,"CUBICSPLINE",c,a,u,l),e._AddKeyframeValue(c,r,s,i,t,l,u),e.AddSplineTangent(t,n.OUTTANGENT,s,i,"CUBICSPLINE",c,a,u,l)})},e._GetBasePositionRotationOrScale=function(e,t,r,n){var o;return"rotation"===t?n?e.rotationQuaternion?(o=e.rotationQuaternion.asArray(),r&&(a.a._GetRightHandedQuaternionArrayFromRef(o),e.parent||(o=i.Quaternion.FromArray([0,1,0,0]).multiply(i.Quaternion.FromArray(o)).asArray()))):o=i.Quaternion.Identity().asArray():(o=e.rotation.asArray(),a.a._GetRightHandedNormalArray3FromRef(o)):"translation"===t?(o=e.position.asArray(),r&&a.a._GetRightHandedPositionArray3FromRef(o)):o=e.scaling.asArray(),o},e._AddKeyframeValue=function(e,t,r,n,o,s,l){var u,c,f=t.dataType;if(f===i.Animation.ANIMATIONTYPE_VECTOR3){if(u=e.value.asArray(),"rotation"===n){var h=i.Vector3.FromArray(u),p=i.Quaternion.RotationYawPitchRoll(h.y,h.x,h.z);s&&(a.a._GetRightHandedQuaternionFromRef(p),o.parent||(p=i.Quaternion.FromArray([0,1,0,0]).multiply(p))),u=p.asArray()}else"translation"===n&&s&&(a.a._GetRightHandedNormalArray3FromRef(u),o.parent||(u[0]*=-1,u[2]*=-1));r.push(u)}else if(f===i.Animation.ANIMATIONTYPE_FLOAT){if(c=this._ConvertFactorToVector3OrQuaternion(e.value,o,t,f,n,s,l)){if("rotation"===n){var d=l?c:i.Quaternion.RotationYawPitchRoll(c.y,c.x,c.z).normalize();s&&(a.a._GetRightHandedQuaternionFromRef(d),o.parent||(d=i.Quaternion.FromArray([0,1,0,0]).multiply(d))),r.push(d.asArray())}else"translation"===n&&s&&(a.a._GetRightHandedNormalVector3FromRef(c),o.parent||(c.x*=-1,c.z*=-1));r.push(c.asArray())}}else f===i.Animation.ANIMATIONTYPE_QUATERNION?(u=e.value.normalize().asArray(),s&&(a.a._GetRightHandedQuaternionArrayFromRef(u),o.parent||(u=i.Quaternion.FromArray([0,1,0,0]).multiply(i.Quaternion.FromArray(u)).asArray())),r.push(u)):i.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")},e._DeduceInterpolation=function(e,t,r){var n,a,o=!1;if("rotation"===t&&!r)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(var s=0,l=e.length;s<l;++s)if((a=e[s]).inTangent||a.outTangent)if(n){if("CUBICSPLINE"!==n){n="LINEAR",o=!0;break}}else n="CUBICSPLINE";else if(n){if("CUBICSPLINE"===n||a.interpolation&&a.interpolation===i.AnimationKeyInterpolation.STEP&&"STEP"!==n){n="LINEAR",o=!0;break}}else n=a.interpolation&&a.interpolation===i.AnimationKeyInterpolation.STEP?"STEP":"LINEAR";return n||(n="LINEAR"),{interpolationType:n,shouldBakeAnimation:o}},e.AddSplineTangent=function(e,t,r,o,s,l,u,c,f){var h,p=t===n.INTANGENT?l.inTangent:l.outTangent;if("CUBICSPLINE"===s){if("rotation"===o)if(p){if(c)h=p.scale(u).asArray();else{var d=p.scale(u);h=i.Quaternion.RotationYawPitchRoll(d.y,d.x,d.z).asArray()}f&&(a.a._GetRightHandedQuaternionArrayFromRef(h),e.parent||(h=i.Quaternion.FromArray([0,1,0,0]).multiply(i.Quaternion.FromArray(h)).asArray()))}else h=[0,0,0,0];else p?(h=p.scale(u).asArray(),f&&"translation"===o&&(a.a._GetRightHandedPositionArray3FromRef(h),e.parent||(h[0]*=-1,h[2]*=-1))):h=[0,0,0];r.push(h)}},e.calculateMinMaxKeyFrames=function(e){var t=1/0,r=-1/0;return e.forEach(function(e){t=Math.min(t,e.frame),r=Math.max(r,e.frame)}),{min:t,max:r}},e}()},function(e,t,r){"use strict";r.r(t),r.d(t,"GLTF2Export",function(){return i});var n=r(2),i=function(){function e(){}return e.GLTFAsync=function(e,t,r){return e.whenReadyAsync().then(function(){var i=t.replace(/\.[^\/.]+$/,"");return new n.b(e,r)._generateGLTFAsync(i)})},e._PreExportAsync=function(e,t){return Promise.resolve().then(function(){return t&&t.exportWithoutWaitingForScene?Promise.resolve():e.whenReadyAsync()})},e._PostExportAsync=function(e,t,r){return Promise.resolve().then(function(){return r&&r.exportWithoutWaitingForScene,t})},e.GLBAsync=function(e,t,r){var i=this;return this._PreExportAsync(e,r).then(function(){var a=t.replace(/\.[^\/.]+$/,"");return new n.b(e,r)._generateGLBAsync(a).then(function(t){return i._PostExportAsync(e,t,r)})})},e}()},function(e,t,r){"use strict";r.r(t);var n=r(0),i=r(2),a="precision highp float;\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 textureTransformMat;\nvoid main(void) {\nvec2 uvTransformed=(textureTransformMat*vec4(vUV.xy,1,1)).xy;\ngl_FragColor=texture2D(textureSampler,uvTransformed);\n}";n.Effect.ShadersStore.textureTransformPixelShader=a;var o="KHR_texture_transform",s=function(){function e(e){this.name=o,this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){delete this._exporter},e.prototype.preExportTextureAsync=function(e,t,r){var n=this;return new Promise(function(r,i){var a=t.getScene();if(a){var o={};if(0===t.uOffset&&0===t.vOffset||(o.offset=[t.uOffset,t.vOffset]),1===t.uScale&&1===t.vScale||(o.scale=[t.uScale,t.vScale]),0!==t.wAng&&(o.rotation=t.wAng),Object.keys(o).length)return n._textureTransformTextureAsync(t,a).then(function(e){r(e)}).catch(function(e){i(e)});r(t)}else i(e+': "scene" is not defined for Babylon texture '+t.name+"!")})},e.prototype._textureTransformTextureAsync=function(e,t){return new Promise(function(r){var i=new n.ProceduralTexture(""+e.name,e.getSize(),"textureTransform",t);i||(n.Tools.Log("Cannot create procedural texture for "+e.name+"!"),r(e)),i.setTexture("textureSampler",e),i.setMatrix("textureTransformMat",e.getTextureMatrix()),i.isReady()?(i.render(),r(i)):i.getEffect().executeWhenCompiled(function(){i.render(),r(i)})})},e}();i.b.RegisterExtension(o,function(e){return new s(e)});var l,u=r(1),c="KHR_lights_punctual";!function(e){e.DIRECTIONAL="directional",e.POINT="point",e.SPOT="spot"}(l||(l={}));var f=function(){function e(e){this.name=c,this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){delete this._exporter,delete this._lights},e.prototype.onExporting=function(){this._lights&&(null==this._exporter._glTF.extensionsUsed&&(this._exporter._glTF.extensionsUsed=[]),-1===this._exporter._glTF.extensionsUsed.indexOf(c)&&this._exporter._glTF.extensionsUsed.push(c),this.required&&(null==this._exporter._glTF.extensionsRequired&&(this._exporter._glTF.extensionsRequired=[]),-1===this._exporter._glTF.extensionsRequired.indexOf(c)&&this._exporter._glTF.extensionsRequired.push(c)),null==this._exporter._glTF.extensions&&(this._exporter._glTF.extensions={}),this._exporter._glTF.extensions[c]=this._lights)},e.prototype.postExportNodeAsync=function(e,t,r){var i=this;return new Promise(function(a,o){if(r instanceof n.ShadowLight){var s=r,f=void 0,h=s.getTypeID()==n.Light.LIGHTTYPEID_POINTLIGHT?l.POINT:s.getTypeID()==n.Light.LIGHTTYPEID_DIRECTIONALLIGHT?l.DIRECTIONAL:s.getTypeID()==n.Light.LIGHTTYPEID_SPOTLIGHT?l.SPOT:null;if(null==h)n.Logger.Warn(e+": Light "+s.name+" is not supported in "+c);else{var p=s.position.clone();if(p.equals(n.Vector3.Zero())||(i._exporter._convertToRightHandedSystem&&u.a._GetRightHandedPositionVector3FromRef(p),t.translation=p.asArray()),h!==l.POINT){var d=s.direction,m=-Math.atan2(d.z,d.x)+Math.PI/2,g=Math.sqrt(d.x*d.x+d.z*d.z),_=-Math.atan2(d.y,g),y=n.Quaternion.RotationYawPitchRoll(m,_,0);i._exporter._convertToRightHandedSystem&&u.a._GetRightHandedQuaternionFromRef(y),y.equals(n.Quaternion.Identity())||(t.rotation=y.asArray())}if(s.falloffType!==n.Light.FALLOFF_GLTF&&n.Logger.Warn(e+": Light falloff for "+s.name+" does not match the "+c+" specification!"),f={type:h},s.diffuse.equals(n.Color3.White())||(f.color=s.diffuse.asArray()),1!==s.intensity&&(f.intensity=s.intensity),s.range!==Number.MAX_VALUE&&(f.range=s.range),h===l.SPOT){var x=s;x.angle!==Math.PI/2&&(null==f.spot&&(f.spot={}),f.spot.outerConeAngle=x.angle/2),0!==x.innerAngle&&(null==f.spot&&(f.spot={}),f.spot.innerConeAngle=x.innerAngle/2)}null==i._lights&&(i._lights={lights:[]}),i._lights.lights.push(f),null==t.extensions&&(t.extensions={});var T={light:i._lights.lights.length-1};t.extensions[c]=T}}a(t)})},e}();i.b.RegisterExtension(c,function(e){return new f(e)}),r.d(t,"KHR_texture_transform",function(){return s}),r.d(t,"KHR_lights_punctual",function(){return f})},function(e,t,r){"use strict";r.d(t,"a",function(){return i});var n=r(0),i=function(){function e(e){this._textureMap={},this._textureMap={},this._exporter=e}return e.FuzzyEquals=function(e,t,r){return n.Scalar.WithinEpsilon(e.r,t.r,r)&&n.Scalar.WithinEpsilon(e.g,t.g,r)&&n.Scalar.WithinEpsilon(e.b,t.b,r)},e.prototype._convertMaterialsToGLTFAsync=function(e,t,r){for(var i=[],a=0,o=e;a<o.length;a++){var s=o[a];s instanceof n.StandardMaterial?i.push(this._convertStandardMaterialAsync(s,t,r)):s instanceof n.PBRMetallicRoughnessMaterial?i.push(this._convertPBRMetallicRoughnessMaterialAsync(s,t,r)):s instanceof n.PBRMaterial?i.push(this._convertPBRMaterialAsync(s,t,r)):n.Tools.Warn("Unsupported material type: "+s.name)}return Promise.all(i).then(function(){})},e.prototype._stripTexturesFromMaterial=function(e){var t={};if(e){t.name=e.name,t.doubleSided=e.doubleSided,t.alphaMode=e.alphaMode,t.alphaCutoff=e.alphaCutoff,t.emissiveFactor=e.emissiveFactor;var r=e.pbrMetallicRoughness;r&&(t.pbrMetallicRoughness={},t.pbrMetallicRoughness.baseColorFactor=r.baseColorFactor,t.pbrMetallicRoughness.metallicFactor=r.metallicFactor,t.pbrMetallicRoughness.roughnessFactor=r.roughnessFactor)}return t},e.prototype._hasTexturesPresent=function(e){if(e.emissiveTexture||e.normalTexture||e.occlusionTexture)return!0;var t=e.pbrMetallicRoughness;return!(!t||!t.baseColorTexture&&!t.metallicRoughnessTexture)},e.prototype._convertToGLTFPBRMetallicRoughness=function(t){var r=new n.Vector2(0,1),i=new n.Vector2(0,.1),a=new n.Vector2(0,.1),o=new n.Vector2(1300,.1);var s=t.diffuseColor.toLinearSpace().scale(.5),l=t.alpha,u=function(e){return function(e,t,r,n,i){return(1-e)*(1-e)*(1-e)*t+3*(1-e)*(1-e)*e*r+3*(1-e)*e*e*n+e*e*e*i}(Math.pow(e/o.x,.333333),r.y,i.y,a.y,o.y)}(n.Scalar.Clamp(t.specularPower,0,e._MaxSpecularPower));return{baseColorFactor:[s.r,s.g,s.b,l],metallicFactor:0,roughnessFactor:u}},e._SolveMetallic=function(e,t,r){if(t<this._DielectricSpecular.r)return this._DielectricSpecular,0;var i=this._DielectricSpecular.r,a=e*r/(1-this._DielectricSpecular.r)+t-2*this._DielectricSpecular.r,o=a*a-4*i*(this._DielectricSpecular.r-t);return n.Scalar.Clamp((-a+Math.sqrt(o))/(2*i),0,1)},e._SetAlphaMode=function(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)},e.prototype._convertStandardMaterialAsync=function(t,r,i){var a=this._exporter._materialMap,o=this._exporter._materials,s=[],l=this._convertToGLTFPBRMetallicRoughness(t),u={name:t.name};return null==t.backFaceCulling||t.backFaceCulling||(t.twoSidedLighting||n.Tools.Warn(t.name+": Back-face culling enabled and two-sided lighting disabled is not supported in glTF."),u.doubleSided=!0),i&&(t.diffuseTexture&&s.push(this._exportTextureAsync(t.diffuseTexture,r).then(function(e){e&&(l.baseColorTexture=e)})),t.bumpTexture&&s.push(this._exportTextureAsync(t.bumpTexture,r).then(function(e){e&&(u.normalTexture=e,null!=t.bumpTexture&&1!==t.bumpTexture.level&&(u.normalTexture.scale=t.bumpTexture.level))})),t.emissiveTexture&&(u.emissiveFactor=[1,1,1],s.push(this._exportTextureAsync(t.emissiveTexture,r).then(function(e){e&&(u.emissiveTexture=e)}))),t.ambientTexture&&s.push(this._exportTextureAsync(t.ambientTexture,r).then(function(e){if(e){var t={index:e.index};u.occlusionTexture=t,t.strength=1}}))),(t.alpha<1||t.opacityTexture)&&(t.alphaMode===n.Constants.ALPHA_COMBINE?u.alphaMode="BLEND":n.Tools.Warn(t.name+": glTF 2.0 does not support alpha mode: "+t.alphaMode.toString())),t.emissiveColor&&!e.FuzzyEquals(t.emissiveColor,n.Color3.Black(),e._Epsilon)&&(u.emissiveFactor=t.emissiveColor.asArray()),u.pbrMetallicRoughness=l,e._SetAlphaMode(u,t),o.push(u),a[t.uniqueId]=o.length-1,Promise.all(s).then(function(){})},e.prototype._convertPBRMetallicRoughnessMaterialAsync=function(t,r,i){var a=this._exporter._materialMap,o=this._exporter._materials,s=[],l={};t.baseColor&&(l.baseColorFactor=[t.baseColor.r,t.baseColor.g,t.baseColor.b,t.alpha]),null!=t.metallic&&1!==t.metallic&&(l.metallicFactor=t.metallic),null!=t.roughness&&1!==t.roughness&&(l.roughnessFactor=t.roughness);var u={name:t.name};return t.doubleSided&&(u.doubleSided=t.doubleSided),e._SetAlphaMode(u,t),i&&(null!=t.baseTexture&&s.push(this._exportTextureAsync(t.baseTexture,r).then(function(e){e&&(l.baseColorTexture=e)})),t.normalTexture&&s.push(this._exportTextureAsync(t.normalTexture,r).then(function(e){e&&(u.normalTexture=e,1!==t.normalTexture.level&&(u.normalTexture.scale=t.normalTexture.level))})),t.occlusionTexture&&s.push(this._exportTextureAsync(t.occlusionTexture,r).then(function(e){e&&(u.occlusionTexture=e,null!=t.occlusionStrength&&(u.occlusionTexture.strength=t.occlusionStrength))})),t.emissiveTexture&&s.push(this._exportTextureAsync(t.emissiveTexture,r).then(function(e){e&&(u.emissiveTexture=e)}))),e.FuzzyEquals(t.emissiveColor,n.Color3.Black(),e._Epsilon)&&(u.emissiveFactor=t.emissiveColor.asArray()),u.pbrMetallicRoughness=l,o.push(u),a[t.uniqueId]=o.length-1,Promise.all(s).then(function(){})},e.prototype._createBase64FromCanvasAsync=function(e,t,r,i){var a=this;return new Promise(function(i,o){var s,l=n.Constants.TEXTURETYPE_UNSIGNED_INT,u=a._exporter._getLocalEngine();s=new n.Scene(u);var c=u.createRawTexture(e,t,r,n.Constants.TEXTUREFORMAT_RGBA,!1,!0,n.Texture.NEAREST_SAMPLINGMODE,null,l),f=new n.PostProcess("pass","pass",null,null,1,null,n.Texture.NEAREST_SAMPLINGMODE,u,!1,void 0,n.Constants.TEXTURETYPE_UNSIGNED_INT,void 0,null,!1);f.getEffect().executeWhenCompiled(function(){f.onApply=function(e){e._bindTexture("textureSampler",c)},u.setSize(t,r),s.postProcessManager.directRender([f],null),f.dispose(),c.dispose();var e=u.getRenderingCanvas();if(e)if(e.toBlob)n.Tools.ToBlob(e,function(e){if(e){var t=new FileReader;t.onload=function(e){var t=e.target.result;s.dispose(),i(t)},t.readAsDataURL(e)}else o("gltfMaterialExporter: Failed to get blob from image canvas!")});else{var a=e.toDataURL();i(a)}else o("Engine is missing a canvas!")})})},e.prototype._createWhiteTexture=function(e,t,r){for(var i=new Uint8Array(e*t*4),a=0;a<i.length;a+=4)i[a]=i[a+1]=i[a+2]=i[a+3]=255;return n.RawTexture.CreateRGBATexture(i,e,t,r)},e.prototype._resizeTexturesToSameDimensions=function(e,t,r){var i,a,o=e?e.getSize():{width:0,height:0},s=t?t.getSize():{width:0,height:0};return o.width<s.width?(i=e&&e instanceof n.Texture?n.TextureTools.CreateResizedCopy(e,s.width,s.height,!0):this._createWhiteTexture(s.width,s.height,r),a=t):o.width>s.width?(a=t&&t instanceof n.Texture?n.TextureTools.CreateResizedCopy(t,o.width,o.height,!0):this._createWhiteTexture(o.width,o.height,r),i=e):(i=e,a=t),{texture1:i,texture2:a}},e.prototype._convertPixelArrayToFloat32=function(e){if(e instanceof Uint8Array){for(var t=e.length,r=new Float32Array(e.length),n=0;n<t;++n)r[n]=e[n]/255;return r}if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")},e.prototype._convertSpecularGlossinessTexturesToMetallicRoughnessAsync=function(t,r,i,a){var o=[];if(!t&&!r)return Promise.reject("_ConvertSpecularGlosinessTexturesToMetallicRoughness: diffuse and specular glossiness textures are not defined!");var s=t?t.getScene():r?r.getScene():null;if(s){var l=this._resizeTexturesToSameDimensions(t,r,s),u=l.texture1.getSize(),c=void 0,f=void 0,h=u.width,p=u.height,d=l.texture1.readPixels(),m=l.texture2.readPixels();if(!d)return Promise.reject("Failed to retrieve pixels from diffuse texture!");if(c=this._convertPixelArrayToFloat32(d),!m)return Promise.reject("Failed to retrieve pixels from specular glossiness texture!");for(var g=(f=this._convertPixelArrayToFloat32(m)).byteLength,_=new Uint8Array(g),y=new Uint8Array(g),x=n.Color3.Black(),T=0,v=0,A=0;A<p;++A)for(var b=0;b<h;++b){var F=4*(h*A+b),E={diffuseColor:new n.Color3(c[F],c[F+1],c[F+2]).toLinearSpace().multiply(i.diffuseColor),specularColor:new n.Color3(f[F],f[F+1],f[F+2]).toLinearSpace().multiply(i.specularColor),glossiness:f[F+3]*i.glossiness},R=this._convertSpecularGlossinessToMetallicRoughness(E);x.r=Math.max(x.r,R.baseColor.r),x.g=Math.max(x.g,R.baseColor.g),x.b=Math.max(x.b,R.baseColor.b),T=Math.max(T,R.metallic),v=Math.max(v,R.roughness),y[F]=255*R.baseColor.r,y[F+1]=255*R.baseColor.g,y[F+2]=255*R.baseColor.b,y[F+3]=l.texture1.hasAlpha?255*c[F+3]:255,_[F]=0,_[F+1]=255*R.roughness,_[F+2]=255*R.metallic,_[F+3]=255}var S={baseColor:x,metallic:T,roughness:v},M=!1,V=!1;for(A=0;A<p;++A)for(b=0;b<h;++b){var w=4*(h*A+b);y[w]/=S.baseColor.r>e._Epsilon?S.baseColor.r:1,y[w+1]/=S.baseColor.g>e._Epsilon?S.baseColor.g:1,y[w+2]/=S.baseColor.b>e._Epsilon?S.baseColor.b:1;var C=n.Color3.FromInts(y[w],y[w+1],y[w+2]).toGammaSpace();y[w]=255*C.r,y[w+1]=255*C.g,y[w+2]=255*C.b,e.FuzzyEquals(C,n.Color3.White(),e._Epsilon)||(V=!0),_[w+1]/=S.roughness>e._Epsilon?S.roughness:1,_[w+2]/=S.metallic>e._Epsilon?S.metallic:1;var B=n.Color3.FromInts(255,_[w+1],_[w+2]);e.FuzzyEquals(B,n.Color3.White(),e._Epsilon)||(M=!0)}if(M){var P=this._createBase64FromCanvasAsync(_,h,p,a).then(function(e){S.metallicRoughnessTextureBase64=e});o.push(P)}if(V){P=this._createBase64FromCanvasAsync(y,h,p,a).then(function(e){S.baseColorTextureBase64=e});o.push(P)}return Promise.all(o).then(function(){return S})}return Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")},e.prototype._convertSpecularGlossinessToMetallicRoughness=function(t){var r=this._getPerceivedBrightness(t.diffuseColor),i=this._getPerceivedBrightness(t.specularColor),a=1-this._getMaxComponent(t.specularColor),o=e._SolveMetallic(r,i,a),s=t.diffuseColor.scale(a/(1-e._DielectricSpecular.r)/Math.max(1-o,e._Epsilon)),l=t.specularColor.subtract(e._DielectricSpecular.scale(1-o)).scale(1/Math.max(o,e._Epsilon)),u=n.Color3.Lerp(s,l,o*o);return{baseColor:u=u.clampToRef(0,1,u),metallic:o,roughness:1-t.glossiness}},e.prototype._getPerceivedBrightness=function(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0},e.prototype._getMaxComponent=function(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0},e.prototype._convertMetalRoughFactorsToMetallicRoughnessAsync=function(e,t,r,n){var i=[],a={baseColor:e.albedoColor,metallic:e.metallic,roughness:e.roughness};return n&&(e.albedoTexture&&i.push(this._exportTextureAsync(e.albedoTexture,t).then(function(e){e&&(r.baseColorTexture=e)})),e.metallicTexture&&i.push(this._exportTextureAsync(e.metallicTexture,t).then(function(e){e&&(r.metallicRoughnessTexture=e)}))),Promise.all(i).then(function(){return a})},e.prototype._getGLTFTextureSampler=function(e){var t=this._getGLTFTextureWrapModesSampler(e),r=e instanceof n.Texture?e.samplingMode:null;if(null!=r)switch(r){case n.Texture.LINEAR_LINEAR:t.magFilter=9729,t.minFilter=9729;break;case n.Texture.LINEAR_NEAREST:t.magFilter=9729,t.minFilter=9728;break;case n.Texture.NEAREST_LINEAR:t.magFilter=9728,t.minFilter=9729;break;case n.Texture.NEAREST_LINEAR_MIPLINEAR:t.magFilter=9728,t.minFilter=9987;break;case n.Texture.NEAREST_NEAREST:t.magFilter=9728,t.minFilter=9728;break;case n.Texture.NEAREST_LINEAR_MIPNEAREST:t.magFilter=9728,t.minFilter=9985;break;case n.Texture.LINEAR_NEAREST_MIPNEAREST:t.magFilter=9729,t.minFilter=9984;break;case n.Texture.LINEAR_NEAREST_MIPLINEAR:t.magFilter=9729,t.minFilter=9986;break;case n.Texture.NEAREST_NEAREST_MIPLINEAR:t.magFilter=9728,t.minFilter=9986;break;case n.Texture.LINEAR_LINEAR_MIPLINEAR:t.magFilter=9729,t.minFilter=9987;break;case n.Texture.LINEAR_LINEAR_MIPNEAREST:t.magFilter=9729,t.minFilter=9985;break;case n.Texture.NEAREST_NEAREST_MIPNEAREST:t.magFilter=9728,t.minFilter=9984}return t},e.prototype._getGLTFTextureWrapMode=function(e){switch(e){case n.Texture.WRAP_ADDRESSMODE:return 10497;case n.Texture.CLAMP_ADDRESSMODE:return 33071;case n.Texture.MIRROR_ADDRESSMODE:return 33648;default:return n.Tools.Error("Unsupported Texture Wrap Mode "+e+"!"),10497}},e.prototype._getGLTFTextureWrapModesSampler=function(e){var t=this._getGLTFTextureWrapMode(e instanceof n.Texture?e.wrapU:n.Texture.WRAP_ADDRESSMODE),r=this._getGLTFTextureWrapMode(e instanceof n.Texture?e.wrapV:n.Texture.WRAP_ADDRESSMODE);return 10497===t&&10497===r?{}:{wrapS:t,wrapT:r}},e.prototype._convertSpecGlossFactorsToMetallicRoughnessAsync=function(e,t,r,i){var a=this;return Promise.resolve().then(function(){var o=a._exporter._samplers,s=a._exporter._textures,l={diffuseColor:e.albedoColor||n.Color3.White(),specularColor:e.reflectivityColor||n.Color3.White(),glossiness:e.microSurface||1},u=null,c=a._getGLTFTextureSampler(e.albedoTexture);return null!=c.magFilter&&null!=c.minFilter&&null!=c.wrapS&&null!=c.wrapT&&(o.push(c),u=o.length-1),e.reflectivityTexture&&!e.useMicroSurfaceFromReflectivityMapAlpha?Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported"):(e.albedoTexture||e.reflectivityTexture)&&i?a._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(e.albedoTexture,e.reflectivityTexture,l,t).then(function(n){if(n.baseColorTextureBase64){var i=a._getTextureInfoFromBase64(n.baseColorTextureBase64,"bjsBaseColorTexture_"+s.length+".png",t,e.albedoTexture?e.albedoTexture.coordinatesIndex:null,u);i&&(r.baseColorTexture=i)}if(n.metallicRoughnessTextureBase64){var o=a._getTextureInfoFromBase64(n.metallicRoughnessTextureBase64,"bjsMetallicRoughnessTexture_"+s.length+".png",t,e.reflectivityTexture?e.reflectivityTexture.coordinatesIndex:null,u);o&&(r.metallicRoughnessTexture=o)}return n}):a._convertSpecularGlossinessToMetallicRoughness(l)})},e.prototype._convertPBRMaterialAsync=function(e,t,r){var n=this,i={},a={name:e.name};return e.isMetallicWorkflow()?(e.albedoColor&&(i.baseColorFactor=[e.albedoColor.r,e.albedoColor.g,e.albedoColor.b,e.alpha]),this._convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,i,r).then(function(o){return n.setMetallicRoughnessPbrMaterial(o,e,a,i,t,r)})):this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,i,r).then(function(o){return n.setMetallicRoughnessPbrMaterial(o,e,a,i,t,r)})},e.prototype.setMetallicRoughnessPbrMaterial=function(t,r,i,a,o,s){var l=this._exporter._materialMap,u=this._exporter._materials,c=[];if(t){if(e._SetAlphaMode(i,r),e.FuzzyEquals(t.baseColor,n.Color3.White(),e._Epsilon)&&r.alpha>=e._Epsilon||(a.baseColorFactor=[t.baseColor.r,t.baseColor.g,t.baseColor.b,r.alpha]),null!=t.metallic&&1!==t.metallic&&(a.metallicFactor=t.metallic),null!=t.roughness&&1!==t.roughness&&(a.roughnessFactor=t.roughness),null==r.backFaceCulling||r.backFaceCulling||(r.twoSidedLighting||n.Tools.Warn(r.name+": Back-face culling enabled and two-sided lighting disabled is not supported in glTF."),i.doubleSided=!0),s){if(r.bumpTexture){var f=this._exportTextureAsync(r.bumpTexture,o).then(function(e){e&&(i.normalTexture=e,1!==r.bumpTexture.level&&(i.normalTexture.scale=r.bumpTexture.level))});c.push(f)}if(r.ambientTexture){f=this._exportTextureAsync(r.ambientTexture,o).then(function(e){if(e){var t={index:e.index};i.occlusionTexture=t,r.ambientTextureStrength&&(t.strength=r.ambientTextureStrength)}});c.push(f)}if(r.emissiveTexture){f=this._exportTextureAsync(r.emissiveTexture,o).then(function(e){e&&(i.emissiveTexture=e)});c.push(f)}}e.FuzzyEquals(r.emissiveColor,n.Color3.Black(),e._Epsilon)||(i.emissiveFactor=r.emissiveColor.asArray()),i.pbrMetallicRoughness=a,u.push(i),l[r.uniqueId]=u.length-1}return Promise.all(c).then(function(e){})},e.prototype.getPixelsFromTexture=function(e){return e.textureType,n.Constants.TEXTURETYPE_UNSIGNED_INT,e.readPixels()},e.prototype._exportTextureAsync=function(e,t){var r=this,n=this._exporter._extensionsPreExportTextureAsync("exporter",e,t);return n?n.then(function(n){return n?r._exportTextureInfoAsync(n,t):r._exportTextureInfoAsync(e,t)}):this._exportTextureInfoAsync(e,t)},e.prototype._exportTextureInfoAsync=function(e,t){var r=this;return Promise.resolve().then(function(){var n=e.uid;if(n in r._textureMap)return r._textureMap[n];for(var i=r._exporter._samplers,a=r._getGLTFTextureSampler(e),o=null,s=null,l=0;l<i.length;++l){var u=i[l];if(u.minFilter===a.minFilter&&u.magFilter===a.magFilter&&u.wrapS===a.wrapS&&u.wrapT===a.wrapT){s=l;break}}null==s?(i.push(a),o=i.length-1):o=s;var c=r.getPixelsFromTexture(e),f=e.getSize();return r._createBase64FromCanvasAsync(c,f.width,f.height,t).then(function(i){var a=r._getTextureInfoFromBase64(i,e.name.replace(/\.\/|\/|\.\\|\\/g,"_"),t,e.coordinatesIndex,o);return a&&(r._textureMap[n]=a),a})})},e.prototype._getTextureInfoFromBase64=function(e,t,r,i,a){var o=this._exporter._textures,s=this._exporter._images,l=this._exporter._imageData,u=null,c={source:s.length,name:t};null!=a&&(c.sampler=a);for(var f=atob(e.split(",")[1]),h=new ArrayBuffer(f.length),p=new Uint8Array(h),d=0,m=f.length;d<m;++d)p[d]=f.charCodeAt(d);var g={data:p,mimeType:r},_="image/jpeg"===r?".jpeg":".png",y=t+_,x=y;if(y in l&&(y=t+"_"+n.Tools.RandomId()+_),l[y]=g,"image/jpeg"===r||"image/png"===r){var T={name:t,uri:y},v=null;for(d=0;d<s.length;++d)if(s[d].uri===x){v=d;break}null==v?(s.push(T),c.source=s.length-1):c.source=v,o.push(c),u={index:o.length-1},null!=i&&(u.texCoord=i)}else n.Tools.Error("Unsupported texture mime type "+r);return u},e._DielectricSpecular=new n.Color3(.04,.04,.04),e._MaxSpecularPower=1024,e._Epsilon=1e-6,e}()},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},,function(e,t,r){"use strict";r.r(t),function(e){var n=r(4),i=r(3),a=r(8),o=r(9),s=r(6);r.d(t,"__IGLTFExporterExtension",function(){return n.__IGLTFExporterExtension}),r.d(t,"GLTFData",function(){return s.GLTFData}),r.d(t,"GLTF2Export",function(){return s.GLTF2Export}),r.d(t,"_GLTFAnimation",function(){return s._GLTFAnimation}),r.d(t,"_Exporter",function(){return s._Exporter}),r.d(t,"_BinaryWriter",function(){return s._BinaryWriter}),r.d(t,"__IGLTFExporterExtensionV2",function(){return s.__IGLTFExporterExtensionV2}),r.d(t,"_GLTFMaterialExporter",function(){return s._GLTFMaterialExporter}),r.d(t,"_GLTFUtilities",function(){return s._GLTFUtilities}),r.d(t,"KHR_texture_transform",function(){return s.KHR_texture_transform}),r.d(t,"KHR_lights_punctual",function(){return s.KHR_lights_punctual});var l=void 0!==e?e:"undefined"!=typeof window?window:void 0;if(void 0!==l){l.BABYLON=l.BABYLON||{};var u=l.BABYLON;u.GLTF2=u.GLTF2||{},u.GLTF2.Exporter=u.GLTF2.Exporter||{},u.GLTF2.Exporter.Extensions=u.GLTF2.Exporter.Extensions||{};var c=[];for(var f in n)u[f]=n[f],c.push(f);for(var f in i)u[f]=i[f],c.push(f);for(var f in a)u[f]=a[f],c.push(f);for(var f in o)u.GLTF2.Exporter.Extensions[f]=o[f],c.push(f);for(var f in s)c.indexOf(f)>-1||(u.GLTF2.Exporter[f]=s[f])}}.call(this,r(11))}])});
=======
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-serializers"]=t(require("babylonjs")):e.SERIALIZERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=13)}([function(t,r){t.exports=e},function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var n=r(0),o=function(){function e(){}return e._CreateBufferView=function(e,t,r,n,o){var i={buffer:e,byteLength:r};return t&&(i.byteOffset=t),o&&(i.name=o),n&&(i.byteStride=n),i},e._CreateAccessor=function(e,t,r,n,o,i,a,s){var u={name:t,bufferView:e,componentType:n,count:o,type:r};return null!=a&&(u.min=a),null!=s&&(u.max=s),null!=i&&(u.byteOffset=i),u},e._CalculateMinMaxPositions=function(t,r,o,i){var a,s,u,l=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];if(o)for(var f=r,h=r+o;f<h;++f){a=3*f,s=n.Vector3.FromArray(t,a),i&&e._GetRightHandedPositionVector3FromRef(s),u=s.asArray();for(var p=0;p<3;++p){var d=u[p];d<l[p]&&(l[p]=d),d>c[p]&&(c[p]=d),++a}}return{min:l,max:c}},e._GetRightHandedPositionVector3=function(e){return new n.Vector3(e.x,e.y,-e.z)},e._GetRightHandedPositionVector3FromRef=function(e){e.z*=-1},e._GetRightHandedPositionArray3FromRef=function(e){e[2]*=-1},e._GetRightHandedNormalVector3=function(e){return new n.Vector3(e.x,e.y,-e.z)},e._GetRightHandedNormalVector3FromRef=function(e){e.z*=-1},e._GetRightHandedNormalArray3FromRef=function(e){e[2]*=-1},e._GetRightHandedVector4FromRef=function(e){e.z*=-1,e.w*=-1},e._GetRightHandedArray4FromRef=function(e){e[2]*=-1,e[3]*=-1},e._GetRightHandedQuaternionFromRef=function(e){e.x*=-1,e.y*=-1},e._GetRightHandedQuaternionArrayFromRef=function(e){e[0]*=-1,e[1]*=-1},e._NormalizeTangentFromRef=function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)},e}()},function(e,t,r){"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var n=r(0),o=r(10),i=r(1),a=r(3),s=r(7);r.d(t,"b",(function(){return u})),r.d(t,"a",(function(){return l}));var u=function(){function e(e,t){this._extensions={},this._glTF={asset:{generator:"BabylonJS",version:"2.0"}},this._babylonScene=e,this._bufferViews=[],this._accessors=[],this._meshes=[],this._scenes=[],this._nodes=[],this._images=[],this._materials=[],this._materialMap=[],this._textures=[],this._samplers=[],this._animations=[],this._imageData={},this._convertToRightHandedSystem=!this._babylonScene.useRightHandedSystem,this._options=t||{},this._animationSampleRate=t&&t.animationSampleRate?t.animationSampleRate:1/60,this._glTFMaterialExporter=new o.a(this),this._loadExtensions()}return e.prototype._applyExtension=function(e,t,r,n){var o=this;if(r>=t.length)return Promise.resolve(e);var i=n(t[r],e);return i?i.then((function(i){return o._applyExtension(i||e,t,r+1,n)})):this._applyExtension(e,t,r+1,n)},e.prototype._applyExtensions=function(t,r){for(var n=[],o=0,i=e._ExtensionNames;o<i.length;o++){var a=i[o];n.push(this._extensions[a])}return this._applyExtension(t,n,0,r)},e.prototype._extensionsPreExportTextureAsync=function(e,t,r){return this._applyExtensions(t,(function(t,n){return t.preExportTextureAsync&&t.preExportTextureAsync(e,n,r)}))},e.prototype._extensionsPostExportMeshPrimitiveAsync=function(e,t,r,n){return this._applyExtensions(t,(function(t,o){return t.postExportMeshPrimitiveAsync&&t.postExportMeshPrimitiveAsync(e,o,r,n)}))},e.prototype._extensionsPostExportNodeAsync=function(e,t,r){return this._applyExtensions(t,(function(t,n){return t.postExportNodeAsync&&t.postExportNodeAsync(e,n,r)}))},e.prototype._extensionsPostExportMaterialAsync=function(e,t,r){return this._applyExtensions(t,(function(t,n){return t.postExportMaterialAsync&&t.postExportMaterialAsync(e,n,r)}))},e.prototype._extensionsPostExportMaterialAdditionalTextures=function(t,r,n){for(var o=[],i=0,a=e._ExtensionNames;i<a.length;i++){var s=a[i],u=this._extensions[s];u.postExportMaterialAdditionalTextures&&o.push.apply(o,u.postExportMaterialAdditionalTextures(t,r,n))}return o},e.prototype._extensionsPostExportTextures=function(t,r,n){for(var o=0,i=e._ExtensionNames;o<i.length;o++){var a=i[o],s=this._extensions[a];s.postExportTexture&&s.postExportTexture(t,r,n)}},e.prototype._forEachExtensions=function(t){for(var r=0,n=e._ExtensionNames;r<n.length;r++){var o=n[r],i=this._extensions[o];i.enabled&&t(i)}},e.prototype._extensionsOnExporting=function(){var e=this;this._forEachExtensions((function(t){t.wasUsed&&(null==e._glTF.extensionsUsed&&(e._glTF.extensionsUsed=[]),-1===e._glTF.extensionsUsed.indexOf(t.name)&&e._glTF.extensionsUsed.push(t.name),t.required&&(null==e._glTF.extensionsRequired&&(e._glTF.extensionsRequired=[]),-1===e._glTF.extensionsRequired.indexOf(t.name)&&e._glTF.extensionsRequired.push(t.name)),null==e._glTF.extensions&&(e._glTF.extensions={}),t.onExporting&&t.onExporting())}))},e.prototype._loadExtensions=function(){for(var t=0,r=e._ExtensionNames;t<r.length;t++){var n=r[t],o=e._ExtensionFactories[n](this);this._extensions[n]=o}},e.prototype.dispose=function(){for(var e in this._extensions){this._extensions[e].dispose()}},e.RegisterExtension=function(t,r){e.UnregisterExtension(t)&&n.Tools.Warn("Extension with the name "+t+" already exists"),e._ExtensionFactories[t]=r,e._ExtensionNames.push(t)},e.UnregisterExtension=function(t){if(!e._ExtensionFactories[t])return!1;delete e._ExtensionFactories[t];var r=e._ExtensionNames.indexOf(t);return-1!==r&&e._ExtensionNames.splice(r,1),!0},e.prototype._getLocalEngine=function(){if(!this._localEngine){var e=document.createElement("canvas");e.id="WriteCanvas",e.width=2048,e.height=2048,this._localEngine=new n.Engine(e,!0,{premultipliedAlpha:n.Tools.IsSafari(),preserveDrawingBuffer:!0}),this._localEngine.setViewport(new n.Viewport(0,0,1,1))}return this._localEngine},e.prototype.reorderIndicesBasedOnPrimitiveMode=function(e,t,r,o,i){switch(t){case n.Material.TriangleFillMode:o||(o=0);for(var a=e.indexStart,s=e.indexStart+e.indexCount;a<s;a+=3){var u=o+4*a,l=i.getUInt32(u+4),c=i.getUInt32(u+8);i.setUInt32(c,u+4),i.setUInt32(l,u+8)}break;case n.Material.TriangleFanDrawMode:a=e.indexStart+e.indexCount-1;for(var f=e.indexStart;a>=f;--a)i.setUInt32(r[a],o),o+=4;break;case n.Material.TriangleStripDrawMode:e.indexCount>=3&&(i.setUInt32(r[e.indexStart+2],o+4),i.setUInt32(r[e.indexStart+1],o+8))}},e.prototype.reorderVertexAttributeDataBasedOnPrimitiveMode=function(e,t,r,o,i,a,s){if(this._convertToRightHandedSystem&&r===n.Material.ClockWiseSideOrientation)switch(t){case n.Material.TriangleFillMode:this.reorderTriangleFillMode(e,t,r,o,i,a,s);break;case n.Material.TriangleStripDrawMode:this.reorderTriangleStripDrawMode(e,t,r,o,i,a,s);break;case n.Material.TriangleFanDrawMode:this.reorderTriangleFanMode(e,t,r,o,i,a,s)}},e.prototype.reorderTriangleFillMode=function(e,t,r,o,i,a,s){var u=this.getVertexBufferFromMesh(o,e.getMesh());if(u){var l=u.byteStride/n.VertexBuffer.GetTypeByteLength(u.type);if(e.verticesCount%3!=0)n.Tools.Error("The submesh vertices for the triangle fill mode is not divisible by 3!");else{var c=[],f=0;switch(o){case n.VertexBuffer.PositionKind:case n.VertexBuffer.NormalKind:for(var h=e.verticesStart;h<e.verticesStart+e.verticesCount;h+=3)f=h*l,c.push(n.Vector3.FromArray(i,f)),c.push(n.Vector3.FromArray(i,f+2*l)),c.push(n.Vector3.FromArray(i,f+l));break;case n.VertexBuffer.TangentKind:for(h=e.verticesStart;h<e.verticesStart+e.verticesCount;h+=3)f=h*l,c.push(n.Vector4.FromArray(i,f)),c.push(n.Vector4.FromArray(i,f+2*l)),c.push(n.Vector4.FromArray(i,f+l));break;case n.VertexBuffer.ColorKind:var p=u.getSize();for(h=e.verticesStart;h<e.verticesStart+e.verticesCount;h+=p)f=h*l,4===p?(c.push(n.Vector4.FromArray(i,f)),c.push(n.Vector4.FromArray(i,f+2*l)),c.push(n.Vector4.FromArray(i,f+l))):(c.push(n.Vector3.FromArray(i,f)),c.push(n.Vector3.FromArray(i,f+2*l)),c.push(n.Vector3.FromArray(i,f+l)));break;case n.VertexBuffer.UVKind:case n.VertexBuffer.UV2Kind:for(h=e.verticesStart;h<e.verticesStart+e.verticesCount;h+=3)f=h*l,c.push(n.Vector2.FromArray(i,f)),c.push(n.Vector2.FromArray(i,f+2*l)),c.push(n.Vector2.FromArray(i,f+l));break;default:n.Tools.Error("Unsupported Vertex Buffer type: "+o)}this.writeVertexAttributeData(c,a,o,i,s)}}else n.Tools.Warn("reorderTriangleFillMode: Vertex Buffer Kind "+o+" not present!")},e.prototype.reorderTriangleStripDrawMode=function(e,t,r,o,i,a,s){var u=this.getVertexBufferFromMesh(o,e.getMesh());if(u){var l=u.byteStride/n.VertexBuffer.GetTypeByteLength(u.type),c=[],f=0;switch(o){case n.VertexBuffer.PositionKind:case n.VertexBuffer.NormalKind:f=e.verticesStart,c.push(n.Vector3.FromArray(i,f+2*l)),c.push(n.Vector3.FromArray(i,f+l));break;case n.VertexBuffer.TangentKind:for(var h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*l,c.push(n.Vector4.FromArray(i,f));break;case n.VertexBuffer.ColorKind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*l,4===u.getSize()?c.push(n.Vector4.FromArray(i,f)):c.push(n.Vector3.FromArray(i,f));break;case n.VertexBuffer.UVKind:case n.VertexBuffer.UV2Kind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*l,c.push(n.Vector2.FromArray(i,f));break;default:n.Tools.Error("Unsupported Vertex Buffer type: "+o)}this.writeVertexAttributeData(c,a+12,o,i,s)}else n.Tools.Warn("reorderTriangleStripDrawMode: Vertex buffer kind "+o+" not present!")},e.prototype.reorderTriangleFanMode=function(e,t,r,o,i,a,s){var u=this.getVertexBufferFromMesh(o,e.getMesh());if(u){var l=u.byteStride/n.VertexBuffer.GetTypeByteLength(u.type),c=[],f=0;switch(o){case n.VertexBuffer.PositionKind:case n.VertexBuffer.NormalKind:for(var h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*l,c.push(n.Vector3.FromArray(i,f));break;case n.VertexBuffer.TangentKind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*l,c.push(n.Vector4.FromArray(i,f));break;case n.VertexBuffer.ColorKind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*l,c.push(n.Vector4.FromArray(i,f)),4===u.getSize()?c.push(n.Vector4.FromArray(i,f)):c.push(n.Vector3.FromArray(i,f));break;case n.VertexBuffer.UVKind:case n.VertexBuffer.UV2Kind:for(h=e.verticesStart+e.verticesCount-1;h>=e.verticesStart;--h)f=h*l,c.push(n.Vector2.FromArray(i,f));break;default:n.Tools.Error("Unsupported Vertex Buffer type: "+o)}this.writeVertexAttributeData(c,a,o,i,s)}else n.Tools.Warn("reorderTriangleFanMode: Vertex buffer kind "+o+" not present!")},e.prototype.writeVertexAttributeData=function(e,t,r,o,a){for(var s=0,u=e;s<u.length;s++){var l=u[s];!this._convertToRightHandedSystem||r===n.VertexBuffer.ColorKind||l instanceof n.Vector2||(l instanceof n.Vector3?r===n.VertexBuffer.NormalKind?i.a._GetRightHandedNormalVector3FromRef(l):r===n.VertexBuffer.PositionKind?i.a._GetRightHandedPositionVector3FromRef(l):n.Tools.Error("Unsupported vertex attribute kind!"):i.a._GetRightHandedVector4FromRef(l)),r===n.VertexBuffer.NormalKind?l.normalize():r===n.VertexBuffer.TangentKind&&l instanceof n.Vector4&&i.a._NormalizeTangentFromRef(l);for(var c=0,f=l.asArray();c<f.length;c++){var h=f[c];a.setFloat32(h,t),t+=4}}},e.prototype.writeAttributeData=function(e,t,r,o){var a,s=r/4,u=[];switch(e){case n.VertexBuffer.PositionKind:for(var l=0,c=t.length/s;l<c;++l){a=l*s;var f=n.Vector3.FromArray(t,a);this._convertToRightHandedSystem&&i.a._GetRightHandedPositionVector3FromRef(f),u.push(f.asArray())}break;case n.VertexBuffer.NormalKind:l=0;for(var h=t.length/s;l<h;++l){a=l*s;f=n.Vector3.FromArray(t,a);this._convertToRightHandedSystem&&i.a._GetRightHandedNormalVector3FromRef(f),f.normalize(),u.push(f.asArray())}break;case n.VertexBuffer.TangentKind:l=0;for(var p=t.length/s;l<p;++l){a=l*s;f=n.Vector4.FromArray(t,a);this._convertToRightHandedSystem&&i.a._GetRightHandedVector4FromRef(f),i.a._NormalizeTangentFromRef(f),u.push(f.asArray())}break;case n.VertexBuffer.ColorKind:l=0;for(var d=t.length/s;l<d;++l){a=l*s;f=3===s?n.Vector3.FromArray(t,a):n.Vector4.FromArray(t,a);u.push(f.asArray())}break;case n.VertexBuffer.UVKind:case n.VertexBuffer.UV2Kind:l=0;for(var m=t.length/s;l<m;++l)a=l*s,u.push((this._convertToRightHandedSystem,[t[a],t[a+1]]));break;default:n.Tools.Warn("Unsupported Vertex Buffer Type: "+e),u=[]}for(var g=0,_=u;g<_.length;g++)for(var x=0,y=_[g];x<y.length;x++){var T=y[x];o.setFloat32(T)}},e.prototype.generateJSON=function(e,t,r){var n,o,a,s=this,u={byteLength:this._totalByteLength},l=this._totalByteLength;return u.byteLength&&(this._glTF.buffers=[u]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._images&&this._images.length&&(e?(this._glTF.images=[],this._images.forEach((function(e){e.uri&&(o=s._imageData[e.uri],n=e.uri.split(".")[0]+" image",a=i.a._CreateBufferView(0,l,o.data.length,void 0,n),l+=o.data.buffer.byteLength,s._bufferViews.push(a),e.bufferView=s._bufferViews.length-1,e.name=n,e.mimeType=o.mimeType,e.uri=void 0,s._glTF.images||(s._glTF.images=[]),s._glTF.images.push(e))})),u.byteLength=l):this._glTF.images=this._images),e||(u.uri=t+".bin"),r?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)},e.prototype._generateGLTFAsync=function(e,t){var r=this;return void 0===t&&(t=!0),this._generateBinaryAsync().then((function(n){r._extensionsOnExporting();var o=r.generateJSON(!1,e,!0),i=new Blob([n],{type:"application/octet-stream"}),s=e+".gltf",u=e+".bin",l=new a.GLTFData;if(l.glTFFiles[s]=o,l.glTFFiles[u]=i,r._imageData)for(var c in r._imageData)l.glTFFiles[c]=new Blob([r._imageData[c].data],{type:r._imageData[c].mimeType});return t&&r.dispose(),l}))},e.prototype._generateBinaryAsync=function(){var e=this,t=new l(4);return this.createSceneAsync(this._babylonScene,t).then((function(){return e._localEngine&&e._localEngine.dispose(),t.getArrayBuffer()}))},e.prototype._getPadding=function(e){var t=e%4;return 0===t?t:4-t},e.prototype._generateGLBAsync=function(e,t){var r=this;return void 0===t&&(t=!0),this._generateBinaryAsync().then((function(n){r._extensionsOnExporting();var o=r.generateJSON(!0),i=e+".glb",s=o.length,u=0;for(var l in r._imageData)u+=r._imageData[l].data.byteLength;var c=r._getPadding(s),f=r._getPadding(n.byteLength),h=r._getPadding(u),p=28+s+c+n.byteLength+f+u+h,d=new ArrayBuffer(12),m=new DataView(d);m.setUint32(0,1179937895,!0),m.setUint32(4,2,!0),m.setUint32(8,p,!0);var g=new ArrayBuffer(8+s+c),_=new DataView(g);_.setUint32(0,s+c,!0),_.setUint32(4,1313821514,!0);for(var x=new Uint8Array(g,8),y=0;y<s;++y)x[y]=o.charCodeAt(y);var T=new Uint8Array(g,8+s);for(y=0;y<c;++y)T[y]=32;var v=new ArrayBuffer(8),A=new DataView(v);A.setUint32(0,n.byteLength+u+h,!0),A.setUint32(4,5130562,!0);var b=new ArrayBuffer(f),F=new Uint8Array(b);for(y=0;y<f;++y)F[y]=0;var E=new ArrayBuffer(h),R=new Uint8Array(E);for(y=0;y<h;++y)R[y]=0;var M=[d,g,v,n];for(var l in r._imageData)M.push(r._imageData[l].data.buffer);M.push(b),M.push(E);var S=new Blob(M,{type:"application/octet-stream"}),V=new a.GLTFData;return V.glTFFiles[i]=S,null!=r._localEngine&&r._localEngine.dispose(),t&&r.dispose(),V}))},e.prototype.setNodeTransformation=function(e,t){t.getPivotPoint().equalsToFloats(0,0,0)||n.Tools.Warn("Pivot points are not supported in the glTF serializer"),t.position.equalsToFloats(0,0,0)||(e.translation=this._convertToRightHandedSystem?i.a._GetRightHandedPositionVector3(t.position).asArray():t.position.asArray()),t.scaling.equalsToFloats(1,1,1)||(e.scale=t.scaling.asArray());var r=n.Quaternion.RotationYawPitchRoll(t.rotation.y,t.rotation.x,t.rotation.z);t.rotationQuaternion&&r.multiplyInPlace(t.rotationQuaternion),0===r.x&&0===r.y&&0===r.z&&1===r.w||(this._convertToRightHandedSystem&&i.a._GetRightHandedQuaternionFromRef(r),e.rotation=r.normalize().asArray())},e.prototype.getVertexBufferFromMesh=function(e,t){if(t.isVerticesDataPresent(e)){var r=t.getVertexBuffer(e);if(r)return r}return null},e.prototype.createBufferViewKind=function(e,t,r,o){var a=t instanceof n.Mesh?t:t instanceof n.InstancedMesh?t.sourceMesh:null;if(a){var s=a.getVerticesData(e);if(s){var u=4*s.length,l=i.a._CreateBufferView(0,r.getByteOffset(),u,o,e+" - "+a.name);this._bufferViews.push(l),this.writeAttributeData(e,s,o,r)}}},e.prototype.getMeshPrimitiveMode=function(e){return e instanceof n.LinesMesh?n.Material.LineListDrawMode:e.material?e.material.fillMode:n.Material.TriangleFillMode},e.prototype.setPrimitiveMode=function(e,t){switch(t){case n.Material.TriangleFillMode:break;case n.Material.TriangleStripDrawMode:e.mode=5;break;case n.Material.TriangleFanDrawMode:e.mode=6;break;case n.Material.PointListDrawMode:e.mode=0;case n.Material.PointFillMode:e.mode=0;break;case n.Material.LineLoopDrawMode:e.mode=2;break;case n.Material.LineListDrawMode:e.mode=1;break;case n.Material.LineStripDrawMode:e.mode=3}},e.prototype.setAttributeKind=function(e,t){switch(t){case n.VertexBuffer.PositionKind:e.attributes.POSITION=this._accessors.length-1;break;case n.VertexBuffer.NormalKind:e.attributes.NORMAL=this._accessors.length-1;break;case n.VertexBuffer.ColorKind:e.attributes.COLOR_0=this._accessors.length-1;break;case n.VertexBuffer.TangentKind:e.attributes.TANGENT=this._accessors.length-1;break;case n.VertexBuffer.UVKind:e.attributes.TEXCOORD_0=this._accessors.length-1;break;case n.VertexBuffer.UV2Kind:e.attributes.TEXCOORD_1=this._accessors.length-1;break;default:n.Tools.Warn("Unsupported Vertex Buffer Type: "+t)}},e.prototype.setPrimitiveAttributesAsync=function(e,t,r){var o,a,s=[],u=null;t instanceof n.Mesh?u=t:t instanceof n.InstancedMesh&&(u=t.sourceMesh);var l=[{kind:n.VertexBuffer.PositionKind,accessorType:"VEC3",byteStride:12},{kind:n.VertexBuffer.NormalKind,accessorType:"VEC3",byteStride:12},{kind:n.VertexBuffer.ColorKind,accessorType:"VEC4",byteStride:16},{kind:n.VertexBuffer.TangentKind,accessorType:"VEC4",byteStride:16},{kind:n.VertexBuffer.UVKind,accessorType:"VEC2",byteStride:8},{kind:n.VertexBuffer.UV2Kind,accessorType:"VEC2",byteStride:8}];if(u){for(var c=null,f=this.getMeshPrimitiveMode(u),h={},p=0,d=l;p<d.length;p++){var m=(k=d[p]).kind;if(u.isVerticesDataPresent(m)){var g=this.getVertexBufferFromMesh(m,u);k.byteStride=g?4*g.getSize():4*n.VertexBuffer.DeduceStride(m),12===k.byteStride&&(k.accessorType="VEC3"),this.createBufferViewKind(m,t,r,k.byteStride),k.bufferViewIndex=this._bufferViews.length-1,h[m]=k.bufferViewIndex}}if(u.getTotalIndices()){var _=u.getIndices();if(_){var x=4*_.length;o=i.a._CreateBufferView(0,r.getByteOffset(),x,void 0,"Indices - "+u.name),this._bufferViews.push(o),c=this._bufferViews.length-1;for(var y=0,T=_.length;y<T;++y)r.setUInt32(_[y])}}if(u.subMeshes)for(var v=0,A=u.subMeshes;v<A.length;v++){var b=A[v],F=b.getMaterial()||u.getScene().defaultMaterial,E=null;if(F)if(u instanceof n.LinesMesh){var R={name:u.name+" material"};(!u.color.equals(n.Color3.White())||u.alpha<1)&&(R.pbrMetallicRoughness={baseColorFactor:u.color.asArray().concat([u.alpha])}),this._materials.push(R),E=this._materials.length-1}else if(F instanceof n.MultiMaterial){var M=F.subMaterials[b.materialIndex];M&&(F=M,E=this._materialMap[F.uniqueId])}else E=this._materialMap[F.uniqueId];var S=null!=E?this._materials[E]:null,V={attributes:{}};this.setPrimitiveMode(V,f);for(var w=0,C=l;w<C.length;w++){if((m=(k=C[w]).kind)!==n.VertexBuffer.UVKind&&m!==n.VertexBuffer.UV2Kind||!S||this._glTFMaterialExporter._hasTexturesPresent(S))if(U=u.getVerticesData(m))if(g=this.getVertexBufferFromMesh(m,u)){var B=g.getSize(),P=k.bufferViewIndex;if(null!=P){a={min:null,max:null},m==n.VertexBuffer.PositionKind&&(a=i.a._CalculateMinMaxPositions(U,0,U.length/B,this._convertToRightHandedSystem));var I=i.a._CreateAccessor(P,m+" - "+t.name,k.accessorType,5126,U.length/B,0,a.min,a.max);this._accessors.push(I),this.setAttributeKind(V,m)}}}if(c){I=i.a._CreateAccessor(c,"indices - "+t.name,"SCALAR",5125,b.indexCount,4*b.indexStart,null,null);this._accessors.push(I),V.indices=this._accessors.length-1}if(null!=E&&Object.keys(V.attributes).length>0){var L=null!==u.overrideMaterialSideOrientation?u.overrideMaterialSideOrientation:F.sideOrientation;if(L===n.Material.ClockWiseSideOrientation){var N=null!=c?this._bufferViews[c].byteOffset:null;null==N&&(N=0);var G=null;if(null!=c&&(G=u.getIndices()),G)this.reorderIndicesBasedOnPrimitiveMode(b,f,G,N,r);else for(var O=0,D=l;O<D.length;O++){var U,k=D[O];if(U=u.getVerticesData(k.kind)){var K=this._bufferViews[h[k.kind]].byteOffset;K||(K=0),this.reorderVertexAttributeDataBasedOnPrimitiveMode(b,f,L,k.kind,U,K,r)}}}V.material=E}e.primitives.push(V),this._extensionsPostExportMeshPrimitiveAsync("postExport",V,b,r)&&s.push()}}return Promise.all(s).then((function(){}))},e.prototype.createSceneAsync=function(e,t){var r,o,i,a=this,s={nodes:[]},u=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),o=0;for(t=0;t<r;t++)for(var i=arguments[t],a=0,s=i.length;a<s;a++,o++)n[o]=i[a];return n}(e.transformNodes,e.meshes,e.lights);return this._glTFMaterialExporter._convertMaterialsToGLTFAsync(e.materials,"image/png",!0).then((function(){return a.createNodeMapAndAnimationsAsync(e,u,t).then((function(e){if(a._nodeMap=e,a._totalByteLength=t.getByteOffset(),null==a._totalByteLength)throw new Error("undefined byte length!");for(var l=0,c=u;l<c.length;l++){var f=c[l];if(void 0!==(r=a._nodeMap[f.uniqueId])&&(o=a._nodes[r],f.metadata&&(a._options.metadataSelector?o.extras=a._options.metadataSelector(f.metadata):f.metadata.gltf&&(o.extras=f.metadata.gltf.extras)),f.parent||(a._options.shouldExportNode&&!a._options.shouldExportNode(f)?n.Tools.Log("Omitting "+f.name+" from scene."):(a._convertToRightHandedSystem&&(o.translation&&(o.translation[2]*=-1,o.translation[0]*=-1),o.rotation=o.rotation?n.Quaternion.FromArray([0,1,0,0]).multiply(n.Quaternion.FromArray(o.rotation)).asArray():n.Quaternion.FromArray([0,1,0,0]).asArray()),s.nodes.push(r))),i=f.getDescendants(!0),!o.children&&i&&i.length)){for(var h=[],p=0,d=i;p<d.length;p++){var m=d[p];null!=a._nodeMap[m.uniqueId]&&h.push(a._nodeMap[m.uniqueId])}h.length&&(o.children=h)}}s.nodes.length&&a._scenes.push(s)}))}))},e.prototype.createNodeMapAndAnimationsAsync=function(e,t,r){for(var o,i=this,a=Promise.resolve(),u={},l={name:"runtime animations",channels:[],samplers:[]},c=[],f=function(t){!h._options.shouldExportNode||h._options.shouldExportNode(t)?a=a.then((function(){return i.createNodeAsync(t,r).then((function(a){var f=i._extensionsPostExportNodeAsync("createNodeAsync",a,t);return null==f?(n.Tools.Warn("Not exporting node "+t.name),Promise.resolve()):f.then((function(n){n&&(i._nodes.push(n),o=i._nodes.length-1,u[t.uniqueId]=o,!e.animationGroups.length&&t.animations.length&&s.a._CreateNodeAnimationFromNodeAnimations(t,l,c,u,i._nodes,r,i._bufferViews,i._accessors,i._convertToRightHandedSystem,i._animationSampleRate))}))}))})):t.name},h=this,p=0,d=t;p<d.length;p++){f(d[p])}return a.then((function(){return l.channels.length&&l.samplers.length&&i._animations.push(l),c.forEach((function(e){e.channels.length&&e.samplers.length&&i._animations.push(e)})),e.animationGroups.length&&s.a._CreateNodeAnimationFromAnimationGroups(e,i._animations,u,i._nodes,r,i._bufferViews,i._accessors,i._convertToRightHandedSystem,i._animationSampleRate),u}))},e.prototype.createNodeAsync=function(e,t){var r=this;return Promise.resolve().then((function(){var o={},i={primitives:[]};return e.name&&(o.name=e.name),e instanceof n.TransformNode?(r.setNodeTransformation(o,e),r.setPrimitiveAttributesAsync(i,e,t).then((function(){return i.primitives.length&&(r._meshes.push(i),o.mesh=r._meshes.length-1),o}))):o}))},e._ExtensionNames=new Array,e._ExtensionFactories={},e}(),l=function(){function e(e){this._arrayBuffer=new ArrayBuffer(e),this._dataView=new DataView(this._arrayBuffer),this._byteOffset=0}return e.prototype.resizeBuffer=function(e){for(var t=new ArrayBuffer(e),r=new Uint8Array(this._arrayBuffer),n=new Uint8Array(t),o=0,i=n.byteLength;o<i;++o)n[o]=r[o];return this._arrayBuffer=t,this._dataView=new DataView(this._arrayBuffer),t},e.prototype.getArrayBuffer=function(){return this.resizeBuffer(this.getByteOffset())},e.prototype.getByteOffset=function(){if(null==this._byteOffset)throw new Error("Byte offset is undefined!");return this._byteOffset},e.prototype.setUInt8=function(e,t){null!=t?t<this._byteOffset?this._dataView.setUint8(t,e):n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint8(this._byteOffset++,e))},e.prototype.getUInt32=function(e){if(e<this._byteOffset)return this._dataView.getUint32(e,!0);throw n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"),new Error("BinaryWriter: byteoffset is greater than the current binary buffer length!")},e.prototype.getVector3Float32FromRef=function(e,t){t+8>this._byteOffset?n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0))},e.prototype.setVector3Float32FromRef=function(e,t){t+8>this._byteOffset?n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0))},e.prototype.getVector4Float32FromRef=function(e,t){t+12>this._byteOffset?n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0),e.w=this._dataView.getFloat32(t+12,!0))},e.prototype.setVector4Float32FromRef=function(e,t){t+12>this._byteOffset?n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0),this._dataView.setFloat32(t+12,e.w,!0))},e.prototype.setFloat32=function(e,t){isNaN(e)&&n.Tools.Error("Invalid data being written!"),null!=t&&(t<this._byteOffset?this._dataView.setFloat32(t,e,!0):n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary length!")),this._byteOffset+4>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.setUInt32=function(e,t){null!=t?t<this._byteOffset?this._dataView.setUint32(t,e,!0):n.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+4>this._arrayBuffer.byteLength&&this.resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4)},e}()},function(e,t,r){"use strict";r.r(t),r.d(t,"GLTFData",(function(){return n}));var n=function(){function e(){this.glTFFiles={}}return e.prototype.downloadFiles=function(){function e(e,t){return-1!==e.indexOf(t,e.length-t.length)}for(var t in this.glTFFiles){var r=document.createElement("a");document.body.appendChild(r),r.setAttribute("type","hidden"),r.download=t;var n=this.glTFFiles[t],o=void 0;e(t,".glb")?o={type:"model/gltf-binary"}:e(t,".bin")?o={type:"application/octet-stream"}:e(t,".gltf")?o={type:"model/gltf+json"}:e(t,".jpeg")?o={type:"image/jpeg"}:e(t,".png")&&(o={type:"image/png"}),r.href=window.URL.createObjectURL(new Blob([n],o)),r.click()}},e}()},function(e,t,r){"use strict";r.r(t),r.d(t,"__IGLTFExporterExtension",(function(){return n}));var n=0},,function(e,t,r){"use strict";r.r(t);var n=r(7),o=r(3),i=r(2),a=r(10),s=r(8),u=r(1),l=r(9);r.d(t,"_GLTFAnimation",(function(){return n.a})),r.d(t,"GLTFData",(function(){return o.GLTFData})),r.d(t,"_Exporter",(function(){return i.b})),r.d(t,"_BinaryWriter",(function(){return i.a})),r.d(t,"__IGLTFExporterExtensionV2",(function(){return 0})),r.d(t,"_GLTFMaterialExporter",(function(){return a.a})),r.d(t,"GLTF2Export",(function(){return s.GLTF2Export})),r.d(t,"_GLTFUtilities",(function(){return u.a})),r.d(t,"KHR_texture_transform",(function(){return l.KHR_texture_transform})),r.d(t,"KHR_lights_punctual",(function(){return l.KHR_lights_punctual})),r.d(t,"KHR_materials_sheen",(function(){return l.KHR_materials_sheen}))},function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var n,o=r(0),i=r(1);!function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"}(n||(n={}));var a=function(){function e(){}return e._CreateNodeAnimation=function(t,r,n,i,a,s){var u=[],l=[],c=r.getKeys(),f=e.calculateMinMaxKeyFrames(c),h=e._DeduceInterpolation(c,n,a),p=f.max-f.min,d=h.interpolationType,m=h.shouldBakeAnimation;return m?e._CreateBakedAnimation(t,r,n,f.min,f.max,r.framePerSecond,s,u,l,f,i,a):"LINEAR"===d||"STEP"===d?e._CreateLinearOrStepAnimation(t,r,n,p,u,l,i,a):"CUBICSPLINE"===d?e._CreateCubicSplineAnimation(t,r,n,p,u,l,i,a):e._CreateBakedAnimation(t,r,n,f.min,f.max,r.framePerSecond,s,u,l,f,i,a),u.length&&l.length?{inputs:u,outputs:l,samplerInterpolation:d,inputsMin:m?f.min:o.Tools.FloatRound(f.min/r.framePerSecond),inputsMax:m?f.max:o.Tools.FloatRound(f.max/r.framePerSecond)}:null},e._DeduceAnimationInfo=function(e){var t=null,r="VEC3",n=!1,i=e.targetProperty.split(".");switch(i[0]){case"scaling":t="scale";break;case"position":t="translation";break;case"rotation":r="VEC4",t="rotation";break;case"rotationQuaternion":r="VEC4",n=!0,t="rotation";break;default:o.Tools.Error("Unsupported animatable property "+i[0])}return t?{animationChannelTargetPath:t,dataAccessorType:r,useQuaternion:n}:(o.Tools.Error("animation channel target path and data accessor type could be deduced"),null)},e._CreateNodeAnimationFromNodeAnimations=function(t,r,n,i,a,s,u,l,c,f){var h;if(t instanceof o.TransformNode&&t.animations)for(var p=0,d=t.animations;p<d.length;p++){var m=d[p],g=e._DeduceAnimationInfo(m);g&&(h={name:m.name,samplers:[],channels:[]},e.AddAnimation(""+m.name,m.hasRunningRuntimeAnimations?r:h,t,m,g.dataAccessorType,g.animationChannelTargetPath,i,s,u,l,c,g.useQuaternion,f),h.samplers.length&&h.channels.length&&n.push(h))}},e._CreateNodeAnimationFromAnimationGroups=function(t,r,n,i,a,s,u,l,c){var f;if(t.animationGroups)for(var h=0,p=t.animationGroups;h<p.length;h++){var d=p[h];f={name:d.name,channels:[],samplers:[]};for(var m=0,g=d.targetedAnimations;m<g.length;m++){var _=g[m],x=_.target,y=_.animation;if(x instanceof o.TransformNode||1===x.length&&x[0]instanceof o.TransformNode){var T=e._DeduceAnimationInfo(_.animation);if(T){var v=x instanceof o.TransformNode?x:x[0];e.AddAnimation(""+y.name,f,v,y,T.dataAccessorType,T.animationChannelTargetPath,n,a,s,u,l,T.useQuaternion,c)}}}f.channels.length&&f.samplers.length&&r.push(f)}},e.AddAnimation=function(t,r,n,o,a,s,u,l,c,f,h,p,d){var m,g,_,x,y,T,v,A=e._CreateNodeAnimation(n,o,s,h,p,d);if(A){var b=u[n.uniqueId],F=4*A.inputs.length;m=i.a._CreateBufferView(0,l.getByteOffset(),F,void 0,t+"  keyframe data view"),c.push(m),A.inputs.forEach((function(e){l.setFloat32(e)})),g=i.a._CreateAccessor(c.length-1,t+"  keyframes","SCALAR",5126,A.inputs.length,null,[A.inputsMin],[A.inputsMax]),f.push(g),_=f.length-1,y=A.outputs.length,F="VEC3"===a?12*A.outputs.length:16*A.outputs.length,m=i.a._CreateBufferView(0,l.getByteOffset(),F,void 0,t+"  data view"),c.push(m),A.outputs.forEach((function(e){e.forEach((function(e){l.setFloat32(e)}))})),g=i.a._CreateAccessor(c.length-1,t+"  data",a,5126,y,null,null,null),f.push(g),x=f.length-1,T={interpolation:A.samplerInterpolation,input:_,output:x},r.samplers.push(T),v={sampler:r.samplers.length-1,target:{node:b,path:s}},r.channels.push(v)}},e._CreateBakedAnimation=function(t,r,n,i,a,s,u,l,c,f,h,p){var d,m,g=o.Quaternion.Identity(),_=null,x=null,y=null,T=null,v=null,A=null;f.min=o.Tools.FloatRound(i/s);for(var b=r.getKeys(),F=0,E=b.length;F<E;++F){if(A=null,y=b[F],F+1<E)if(T=b[F+1],y.value.equals&&y.value.equals(T.value)||y.value===T.value){if(0!==F)continue;A=y.frame}else A=T.frame;else{if(v=b[F-1],y.value.equals&&y.value.equals(v.value)||y.value===v.value)continue;A=a}if(A)for(var R=y.frame;R<=A;R+=u)if((m=o.Tools.FloatRound(R/s))!==_){_=m,x=m;var M={key:0,repeatCount:0,loopMode:r.loopMode};d=r._interpolate(R,M),e._SetInterpolatedValue(t,d,m,r,n,g,l,c,h,p)}}x&&(f.max=x)},e._ConvertFactorToVector3OrQuaternion=function(t,r,n,i,a,s,u){var l,c,f=null,h=e._GetBasePositionRotationOrScale(r,a,s,u);if(i===o.Animation.ANIMATIONTYPE_FLOAT)switch(c=(l=n.targetProperty.split("."))?l[1]:"",f=u?o.Quaternion.FromArray(h).normalize():o.Vector3.FromArray(h),c){case"x":case"y":f[c]=s&&u&&"scale"!==a?-t:t;break;case"z":f[c]=s&&!u&&"scale"!==a?-t:t;break;case"w":f.w=t;break;default:o.Tools.Error('glTFAnimation: Unsupported component type "'+c+'" for scale animation!')}return f},e._SetInterpolatedValue=function(e,t,r,n,a,s,u,l,c,f){var h,p=n.dataType;u.push(r),"number"==typeof t&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,n,p,a,c,f)),t&&("rotation"===a?(f?s=t:(h=t,o.Quaternion.RotationYawPitchRollToRef(h.y,h.x,h.z,s)),c&&(i.a._GetRightHandedQuaternionFromRef(s),e.parent||(s=o.Quaternion.FromArray([0,1,0,0]).multiply(s))),l.push(s.asArray())):(h=t,c&&"scale"!==a&&(i.a._GetRightHandedPositionVector3FromRef(h),e.parent||(h.x*=-1,h.z*=-1)),l.push(h.asArray())))},e._CreateLinearOrStepAnimation=function(t,r,n,o,i,a,s,u){for(var l=0,c=r.getKeys();l<c.length;l++){var f=c[l];i.push(f.frame/r.framePerSecond),e._AddKeyframeValue(f,r,a,n,t,s,u)}},e._CreateCubicSplineAnimation=function(t,r,o,i,a,s,u,l){r.getKeys().forEach((function(c){a.push(c.frame/r.framePerSecond),e.AddSplineTangent(t,n.INTANGENT,s,o,"CUBICSPLINE",c,i,l,u),e._AddKeyframeValue(c,r,s,o,t,u,l),e.AddSplineTangent(t,n.OUTTANGENT,s,o,"CUBICSPLINE",c,i,l,u)}))},e._GetBasePositionRotationOrScale=function(e,t,r,n){var a;return"rotation"===t?n?e.rotationQuaternion?(a=e.rotationQuaternion.asArray(),r&&(i.a._GetRightHandedQuaternionArrayFromRef(a),e.parent||(a=o.Quaternion.FromArray([0,1,0,0]).multiply(o.Quaternion.FromArray(a)).asArray()))):a=o.Quaternion.Identity().asArray():(a=e.rotation.asArray(),i.a._GetRightHandedNormalArray3FromRef(a)):"translation"===t?(a=e.position.asArray(),r&&i.a._GetRightHandedPositionArray3FromRef(a)):a=e.scaling.asArray(),a},e._AddKeyframeValue=function(e,t,r,n,a,s,u){var l,c,f=t.dataType;if(f===o.Animation.ANIMATIONTYPE_VECTOR3){if(l=e.value.asArray(),"rotation"===n){var h=o.Vector3.FromArray(l),p=o.Quaternion.RotationYawPitchRoll(h.y,h.x,h.z);s&&(i.a._GetRightHandedQuaternionFromRef(p),a.parent||(p=o.Quaternion.FromArray([0,1,0,0]).multiply(p))),l=p.asArray()}else"translation"===n&&s&&(i.a._GetRightHandedNormalArray3FromRef(l),a.parent||(l[0]*=-1,l[2]*=-1));r.push(l)}else if(f===o.Animation.ANIMATIONTYPE_FLOAT){if(c=this._ConvertFactorToVector3OrQuaternion(e.value,a,t,f,n,s,u)){if("rotation"===n){var d=u?c:o.Quaternion.RotationYawPitchRoll(c.y,c.x,c.z).normalize();s&&(i.a._GetRightHandedQuaternionFromRef(d),a.parent||(d=o.Quaternion.FromArray([0,1,0,0]).multiply(d))),r.push(d.asArray())}else"translation"===n&&s&&(i.a._GetRightHandedNormalVector3FromRef(c),a.parent||(c.x*=-1,c.z*=-1));r.push(c.asArray())}}else f===o.Animation.ANIMATIONTYPE_QUATERNION?(l=e.value.normalize().asArray(),s&&(i.a._GetRightHandedQuaternionArrayFromRef(l),a.parent||(l=o.Quaternion.FromArray([0,1,0,0]).multiply(o.Quaternion.FromArray(l)).asArray())),r.push(l)):o.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")},e._DeduceInterpolation=function(e,t,r){var n,i,a=!1;if("rotation"===t&&!r)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(var s=0,u=e.length;s<u;++s)if((i=e[s]).inTangent||i.outTangent)if(n){if("CUBICSPLINE"!==n){n="LINEAR",a=!0;break}}else n="CUBICSPLINE";else if(n){if("CUBICSPLINE"===n||i.interpolation&&i.interpolation===o.AnimationKeyInterpolation.STEP&&"STEP"!==n){n="LINEAR",a=!0;break}}else n=i.interpolation&&i.interpolation===o.AnimationKeyInterpolation.STEP?"STEP":"LINEAR";return n||(n="LINEAR"),{interpolationType:n,shouldBakeAnimation:a}},e.AddSplineTangent=function(e,t,r,a,s,u,l,c,f){var h,p=t===n.INTANGENT?u.inTangent:u.outTangent;if("CUBICSPLINE"===s){if("rotation"===a)if(p){if(c)h=p.scale(l).asArray();else{var d=p.scale(l);h=o.Quaternion.RotationYawPitchRoll(d.y,d.x,d.z).asArray()}f&&(i.a._GetRightHandedQuaternionArrayFromRef(h),e.parent||(h=o.Quaternion.FromArray([0,1,0,0]).multiply(o.Quaternion.FromArray(h)).asArray()))}else h=[0,0,0,0];else p?(h=p.scale(l).asArray(),f&&"translation"===a&&(i.a._GetRightHandedPositionArray3FromRef(h),e.parent||(h[0]*=-1,h[2]*=-1))):h=[0,0,0];r.push(h)}},e.calculateMinMaxKeyFrames=function(e){var t=1/0,r=-1/0;return e.forEach((function(e){t=Math.min(t,e.frame),r=Math.max(r,e.frame)})),{min:t,max:r}},e}()},function(e,t,r){"use strict";r.r(t),r.d(t,"GLTF2Export",(function(){return o}));var n=r(2),o=function(){function e(){}return e.GLTFAsync=function(e,t,r){return e.whenReadyAsync().then((function(){var o=t.replace(/\.[^/.]+$/,"");return new n.b(e,r)._generateGLTFAsync(o)}))},e._PreExportAsync=function(e,t){return Promise.resolve().then((function(){return t&&t.exportWithoutWaitingForScene?Promise.resolve():e.whenReadyAsync()}))},e._PostExportAsync=function(e,t,r){return Promise.resolve().then((function(){return r&&r.exportWithoutWaitingForScene,t}))},e.GLBAsync=function(e,t,r){var o=this;return this._PreExportAsync(e,r).then((function(){var i=t.replace(/\.[^/.]+$/,"");return new n.b(e,r)._generateGLBAsync(i).then((function(t){return o._PostExportAsync(e,t,r)}))}))},e}()},function(e,t,r){"use strict";r.r(t);var n=r(0),o=r(2),i="precision highp float;\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 textureTransformMat;\nvoid main(void) {\nvec2 uvTransformed=(textureTransformMat*vec4(vUV.xy,1,1)).xy;\ngl_FragColor=texture2D(textureSampler,uvTransformed);\n}";n.Effect.ShadersStore.textureTransformPixelShader=i;var a="KHR_texture_transform",s=function(){function e(e){this._recordedTextures=[],this.name=a,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){for(var e=0,t=this._recordedTextures;e<t.length;e++){t[e].dispose()}},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!0,configurable:!0}),e.prototype.postExportTexture=function(e,t,r){if(r&&0===r.uRotationCenter&&0===r.vRotationCenter){var n={},o=!1;if(0===r.uOffset&&0===r.vOffset||(n.offset=[r.uOffset,r.vOffset],o=!0),1===r.uScale&&1===r.vScale||(n.scale=[r.uScale,r.vScale],o=!0),0!==r.wAng&&(n.rotation=r.wAng,o=!0),0!==r.coordinatesIndex&&(n.texCoord=r.coordinatesIndex,o=!0),!o)return;this._wasUsed=!0,t.extensions||(t.extensions={}),t.extensions[a]=n}},e.prototype.preExportTextureAsync=function(e,t,r){var n=this;return new Promise((function(r,o){var i=t.getScene();if(i){var a=!1;if(0===t.uOffset&&0===t.vOffset||(a=!0),1===t.uScale&&1===t.vScale||(a=!0),0!==t.wAng&&(a=!0),a){if(0!==t.uRotationCenter||0!==t.vRotationCenter)return n._textureTransformTextureAsync(t,i).then((function(e){r(e)})).catch((function(e){o(e)}));r(t)}else r(t)}else o(e+': "scene" is not defined for Babylon texture '+t.name+"!")}))},e.prototype._textureTransformTextureAsync=function(e,t){var r=this;return new Promise((function(o){var i=new n.ProceduralTexture(""+e.name,e.getSize(),"textureTransform",t);i||(n.Tools.Log("Cannot create procedural texture for "+e.name+"!"),o(e)),i.reservedDataStore={hidden:!0,source:e},r._recordedTextures.push(i),i.coordinatesIndex=e.coordinatesIndex,i.setTexture("textureSampler",e),i.setMatrix("textureTransformMat",e.getTextureMatrix()),i.isReady()?(i.render(),o(i)):i.getEffect().executeWhenCompiled((function(){i.render(),o(i)}))}))},e}();o.b.RegisterExtension(a,(function(e){return new s(e)}));var u,l=r(1);!function(e){e.DIRECTIONAL="directional",e.POINT="point",e.SPOT="spot"}(u||(u={}));var c=function(){function e(e){this.name="KHR_lights_punctual",this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){delete this._lights},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return!!this._lights},enumerable:!0,configurable:!0}),e.prototype.onExporting=function(){this._exporter._glTF.extensions.KHR_lights_punctual=this._lights},e.prototype.postExportNodeAsync=function(e,t,r){var o=this;return new Promise((function(i,a){if(r instanceof n.ShadowLight){var s=r,c=void 0,f=s.getTypeID()==n.Light.LIGHTTYPEID_POINTLIGHT?u.POINT:s.getTypeID()==n.Light.LIGHTTYPEID_DIRECTIONALLIGHT?u.DIRECTIONAL:s.getTypeID()==n.Light.LIGHTTYPEID_SPOTLIGHT?u.SPOT:null;if(null==f)n.Logger.Warn(e+": Light "+s.name+" is not supported in KHR_lights_punctual");else{var h=s.position.clone();if(h.equals(n.Vector3.Zero())||(o._exporter._convertToRightHandedSystem&&l.a._GetRightHandedPositionVector3FromRef(h),t.translation=h.asArray()),f!==u.POINT){var p=s.direction,d=-Math.atan2(p.z,p.x)+Math.PI/2,m=Math.sqrt(p.x*p.x+p.z*p.z),g=-Math.atan2(p.y,m),_=n.Quaternion.RotationYawPitchRoll(d,g,0);o._exporter._convertToRightHandedSystem&&l.a._GetRightHandedQuaternionFromRef(_),_.equals(n.Quaternion.Identity())||(t.rotation=_.asArray())}if(s.falloffType!==n.Light.FALLOFF_GLTF&&n.Logger.Warn(e+": Light falloff for "+s.name+" does not match the KHR_lights_punctual specification!"),c={type:f},s.diffuse.equals(n.Color3.White())||(c.color=s.diffuse.asArray()),1!==s.intensity&&(c.intensity=s.intensity),s.range!==Number.MAX_VALUE&&(c.range=s.range),f===u.SPOT){var x=s;x.angle!==Math.PI/2&&(null==c.spot&&(c.spot={}),c.spot.outerConeAngle=x.angle/2),0!==x.innerAngle&&(null==c.spot&&(c.spot={}),c.spot.innerConeAngle=x.innerAngle/2)}null==o._lights&&(o._lights={lights:[]}),o._lights.lights.push(c),null==t.extensions&&(t.extensions={});var y={light:o._lights.lights.length-1};t.extensions.KHR_lights_punctual=y}}i(t)}))},e}();o.b.RegisterExtension("KHR_lights_punctual",(function(e){return new c(e)}));var f=function(){function e(e){this.name="KHR_materials_sheen",this.enabled=!0,this.required=!1,this._textureInfos=[],this._exportedTextures=[],this._wasUsed=!1}return e.prototype.dispose=function(){this._textureInfos=[],this._exportedTextures=[]},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!0,configurable:!0}),e.prototype._getTextureIndex=function(e){var t=this._exportedTextures.indexOf(e);return-1===t&&e.reservedDataStore&&(t=this._exportedTextures.indexOf(e.reservedDataStore.source)),t},e.prototype.postExportTexture=function(e,t,r){var n=this._getTextureIndex(r);n>-1&&(this._textureInfos[n]=t)},e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){return r instanceof n.PBRMaterial&&r.sheen.isEnabled&&r.sheen.texture?(this._exportedTextures.push(r.sheen.texture),[r.sheen.texture]):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var o=this;return new Promise((function(e,i){if(r instanceof n.PBRMaterial){if(!r.sheen.isEnabled)return void e(t);o._wasUsed=!0,null==t.extensions&&(t.extensions={});var a={colorFactor:r.sheen.color.asArray(),intensityFactor:r.sheen.intensity};if(r.sheen.texture){var s=o._getTextureIndex(r.sheen.texture);s>-1&&(a.colorIntensityTexture=o._textureInfos[s])}t.extensions.KHR_materials_sheen=a}e(t)}))},e}();o.b.RegisterExtension("KHR_materials_sheen",(function(e){return new f(e)})),r.d(t,"KHR_texture_transform",(function(){return s})),r.d(t,"KHR_lights_punctual",(function(){return c})),r.d(t,"KHR_materials_sheen",(function(){return f}))},function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var n=r(0),o=function(){function e(e){this._textureMap={},this._textureMap={},this._exporter=e}return e.FuzzyEquals=function(e,t,r){return n.Scalar.WithinEpsilon(e.r,t.r,r)&&n.Scalar.WithinEpsilon(e.g,t.g,r)&&n.Scalar.WithinEpsilon(e.b,t.b,r)},e.prototype._convertMaterialsToGLTFAsync=function(e,t,r){for(var o=[],i=0,a=e;i<a.length;i++){var s=a[i];s instanceof n.StandardMaterial?o.push(this._convertStandardMaterialAsync(s,t,r)):s instanceof n.PBRMetallicRoughnessMaterial?o.push(this._convertPBRMetallicRoughnessMaterialAsync(s,t,r)):s instanceof n.PBRMaterial?o.push(this._convertPBRMaterialAsync(s,t,r)):n.Tools.Warn("Unsupported material type: "+s.name)}return Promise.all(o).then((function(){}))},e.prototype._stripTexturesFromMaterial=function(e){var t={};if(e){t.name=e.name,t.doubleSided=e.doubleSided,t.alphaMode=e.alphaMode,t.alphaCutoff=e.alphaCutoff,t.emissiveFactor=e.emissiveFactor;var r=e.pbrMetallicRoughness;r&&(t.pbrMetallicRoughness={},t.pbrMetallicRoughness.baseColorFactor=r.baseColorFactor,t.pbrMetallicRoughness.metallicFactor=r.metallicFactor,t.pbrMetallicRoughness.roughnessFactor=r.roughnessFactor)}return t},e.prototype._hasTexturesPresent=function(e){if(e.emissiveTexture||e.normalTexture||e.occlusionTexture)return!0;var t=e.pbrMetallicRoughness;return!(!t||!t.baseColorTexture&&!t.metallicRoughnessTexture)},e.prototype._convertToGLTFPBRMetallicRoughness=function(t){var r=new n.Vector2(0,1),o=new n.Vector2(0,.1),i=new n.Vector2(0,.1),a=new n.Vector2(1300,.1);var s=t.diffuseColor.toLinearSpace().scale(.5),u=t.alpha,l=function(e){return function(e,t,r,n,o){return(1-e)*(1-e)*(1-e)*t+3*(1-e)*(1-e)*e*r+3*(1-e)*e*e*n+e*e*e*o}(Math.pow(e/a.x,.333333),r.y,o.y,i.y,a.y)}(n.Scalar.Clamp(t.specularPower,0,e._MaxSpecularPower));return{baseColorFactor:[s.r,s.g,s.b,u],metallicFactor:0,roughnessFactor:l}},e._SolveMetallic=function(e,t,r){if(t<this._DielectricSpecular.r)return this._DielectricSpecular,0;var o=this._DielectricSpecular.r,i=e*r/(1-this._DielectricSpecular.r)+t-2*this._DielectricSpecular.r,a=i*i-4*o*(this._DielectricSpecular.r-t);return n.Scalar.Clamp((-i+Math.sqrt(a))/(2*o),0,1)},e._SetAlphaMode=function(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)},e.prototype._convertStandardMaterialAsync=function(t,r,o){var i=this._exporter._materialMap,a=this._exporter._materials,s=[],u=this._convertToGLTFPBRMetallicRoughness(t),l={name:t.name};return null==t.backFaceCulling||t.backFaceCulling||(t.twoSidedLighting||n.Tools.Warn(t.name+": Back-face culling enabled and two-sided lighting disabled is not supported in glTF."),l.doubleSided=!0),o&&(t.diffuseTexture&&s.push(this._exportTextureAsync(t.diffuseTexture,r).then((function(e){e&&(u.baseColorTexture=e)}))),t.bumpTexture&&s.push(this._exportTextureAsync(t.bumpTexture,r).then((function(e){e&&(l.normalTexture=e,null!=t.bumpTexture&&1!==t.bumpTexture.level&&(l.normalTexture.scale=t.bumpTexture.level))}))),t.emissiveTexture&&(l.emissiveFactor=[1,1,1],s.push(this._exportTextureAsync(t.emissiveTexture,r).then((function(e){e&&(l.emissiveTexture=e)})))),t.ambientTexture&&s.push(this._exportTextureAsync(t.ambientTexture,r).then((function(e){if(e){var t={index:e.index};l.occlusionTexture=t,t.strength=1}})))),(t.alpha<1||t.opacityTexture)&&(t.alphaMode===n.Constants.ALPHA_COMBINE?l.alphaMode="BLEND":n.Tools.Warn(t.name+": glTF 2.0 does not support alpha mode: "+t.alphaMode.toString())),t.emissiveColor&&!e.FuzzyEquals(t.emissiveColor,n.Color3.Black(),e._Epsilon)&&(l.emissiveFactor=t.emissiveColor.asArray()),l.pbrMetallicRoughness=u,e._SetAlphaMode(l,t),a.push(l),i[t.uniqueId]=a.length-1,this._finishMaterial(s,l,t,r)},e.prototype._finishMaterial=function(e,t,r,n){var o=this;return Promise.all(e).then((function(){for(var e=null,i=0,a=o._exporter._extensionsPostExportMaterialAdditionalTextures("exportMaterial",t,r);i<a.length;i++){var s=a[i];e||(e=[]),e.push(o._exportTextureAsync(s,n))}return e||(e=[Promise.resolve(null)]),Promise.all(e).then((function(){var e=o._exporter._extensionsPostExportMaterialAsync("exportMaterial",t,r);return e?e.then((function(){return t})):t}))}))},e.prototype._convertPBRMetallicRoughnessMaterialAsync=function(t,r,o){var i=this._exporter._materialMap,a=this._exporter._materials,s=[],u={};t.baseColor&&(u.baseColorFactor=[t.baseColor.r,t.baseColor.g,t.baseColor.b,t.alpha]),null!=t.metallic&&1!==t.metallic&&(u.metallicFactor=t.metallic),null!=t.roughness&&1!==t.roughness&&(u.roughnessFactor=t.roughness);var l={name:t.name};return t.doubleSided&&(l.doubleSided=t.doubleSided),e._SetAlphaMode(l,t),o&&(null!=t.baseTexture&&s.push(this._exportTextureAsync(t.baseTexture,r).then((function(e){e&&(u.baseColorTexture=e)}))),t.normalTexture&&s.push(this._exportTextureAsync(t.normalTexture,r).then((function(e){e&&(l.normalTexture=e,1!==t.normalTexture.level&&(l.normalTexture.scale=t.normalTexture.level))}))),t.occlusionTexture&&s.push(this._exportTextureAsync(t.occlusionTexture,r).then((function(e){e&&(l.occlusionTexture=e,null!=t.occlusionStrength&&(l.occlusionTexture.strength=t.occlusionStrength))}))),t.emissiveTexture&&s.push(this._exportTextureAsync(t.emissiveTexture,r).then((function(e){e&&(l.emissiveTexture=e)})))),e.FuzzyEquals(t.emissiveColor,n.Color3.Black(),e._Epsilon)&&(l.emissiveFactor=t.emissiveColor.asArray()),l.pbrMetallicRoughness=u,a.push(l),i[t.uniqueId]=a.length-1,this._finishMaterial(s,l,t,r)},e.prototype._createBase64FromCanvasAsync=function(e,t,r,o){var i=this;return new Promise((function(o,a){var s,u=n.Constants.TEXTURETYPE_UNSIGNED_INT,l=i._exporter._getLocalEngine();s=new n.Scene(l);var c=l.createRawTexture(e,t,r,n.Constants.TEXTUREFORMAT_RGBA,!1,!0,n.Texture.NEAREST_SAMPLINGMODE,null,u),f=new n.PostProcess("pass","pass",null,null,1,null,n.Texture.NEAREST_SAMPLINGMODE,l,!1,void 0,n.Constants.TEXTURETYPE_UNSIGNED_INT,void 0,null,!1);f.getEffect().executeWhenCompiled((function(){f.onApply=function(e){e._bindTexture("textureSampler",c)},l.setSize(t,r),s.postProcessManager.directRender([f],null),f.dispose(),c.dispose();var e=l.getRenderingCanvas();if(e)if(e.toBlob)n.Tools.ToBlob(e,(function(e){if(e){var t=new FileReader;t.onload=function(e){var t=e.target.result;s.dispose(),o(t)},t.readAsDataURL(e)}else a("gltfMaterialExporter: Failed to get blob from image canvas!")}));else{var i=e.toDataURL();o(i)}else a("Engine is missing a canvas!")}))}))},e.prototype._createWhiteTexture=function(e,t,r){for(var o=new Uint8Array(e*t*4),i=0;i<o.length;i+=4)o[i]=o[i+1]=o[i+2]=o[i+3]=255;return n.RawTexture.CreateRGBATexture(o,e,t,r)},e.prototype._resizeTexturesToSameDimensions=function(e,t,r){var o,i,a=e?e.getSize():{width:0,height:0},s=t?t.getSize():{width:0,height:0};return a.width<s.width?(o=e&&e instanceof n.Texture?n.TextureTools.CreateResizedCopy(e,s.width,s.height,!0):this._createWhiteTexture(s.width,s.height,r),i=t):a.width>s.width?(i=t&&t instanceof n.Texture?n.TextureTools.CreateResizedCopy(t,a.width,a.height,!0):this._createWhiteTexture(a.width,a.height,r),o=e):(o=e,i=t),{texture1:o,texture2:i}},e.prototype._convertPixelArrayToFloat32=function(e){if(e instanceof Uint8Array){for(var t=e.length,r=new Float32Array(e.length),n=0;n<t;++n)r[n]=e[n]/255;return r}if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")},e.prototype._convertSpecularGlossinessTexturesToMetallicRoughnessAsync=function(t,r,o,i){var a=[];if(!t&&!r)return Promise.reject("_ConvertSpecularGlosinessTexturesToMetallicRoughness: diffuse and specular glossiness textures are not defined!");var s=t?t.getScene():r?r.getScene():null;if(s){var u=this._resizeTexturesToSameDimensions(t,r,s),l=u.texture1.getSize(),c=void 0,f=void 0,h=l.width,p=l.height,d=u.texture1.readPixels(),m=u.texture2.readPixels();if(!d)return Promise.reject("Failed to retrieve pixels from diffuse texture!");if(c=this._convertPixelArrayToFloat32(d),!m)return Promise.reject("Failed to retrieve pixels from specular glossiness texture!");for(var g=(f=this._convertPixelArrayToFloat32(m)).byteLength,_=new Uint8Array(g),x=new Uint8Array(g),y=n.Color3.Black(),T=0,v=0,A=0;A<p;++A)for(var b=0;b<h;++b){var F=4*(h*A+b),E={diffuseColor:new n.Color3(c[F],c[F+1],c[F+2]).toLinearSpace().multiply(o.diffuseColor),specularColor:new n.Color3(f[F],f[F+1],f[F+2]).toLinearSpace().multiply(o.specularColor),glossiness:f[F+3]*o.glossiness},R=this._convertSpecularGlossinessToMetallicRoughness(E);y.r=Math.max(y.r,R.baseColor.r),y.g=Math.max(y.g,R.baseColor.g),y.b=Math.max(y.b,R.baseColor.b),T=Math.max(T,R.metallic),v=Math.max(v,R.roughness),x[F]=255*R.baseColor.r,x[F+1]=255*R.baseColor.g,x[F+2]=255*R.baseColor.b,x[F+3]=u.texture1.hasAlpha?255*c[F+3]:255,_[F]=0,_[F+1]=255*R.roughness,_[F+2]=255*R.metallic,_[F+3]=255}var M={baseColor:y,metallic:T,roughness:v},S=!1,V=!1;for(A=0;A<p;++A)for(b=0;b<h;++b){var w=4*(h*A+b);x[w]/=M.baseColor.r>e._Epsilon?M.baseColor.r:1,x[w+1]/=M.baseColor.g>e._Epsilon?M.baseColor.g:1,x[w+2]/=M.baseColor.b>e._Epsilon?M.baseColor.b:1;var C=n.Color3.FromInts(x[w],x[w+1],x[w+2]).toGammaSpace();x[w]=255*C.r,x[w+1]=255*C.g,x[w+2]=255*C.b,e.FuzzyEquals(C,n.Color3.White(),e._Epsilon)||(V=!0),_[w+1]/=M.roughness>e._Epsilon?M.roughness:1,_[w+2]/=M.metallic>e._Epsilon?M.metallic:1;var B=n.Color3.FromInts(255,_[w+1],_[w+2]);e.FuzzyEquals(B,n.Color3.White(),e._Epsilon)||(S=!0)}if(S){var P=this._createBase64FromCanvasAsync(_,h,p,i).then((function(e){M.metallicRoughnessTextureBase64=e}));a.push(P)}if(V){P=this._createBase64FromCanvasAsync(x,h,p,i).then((function(e){M.baseColorTextureBase64=e}));a.push(P)}return Promise.all(a).then((function(){return M}))}return Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")},e.prototype._convertSpecularGlossinessToMetallicRoughness=function(t){var r=this._getPerceivedBrightness(t.diffuseColor),o=this._getPerceivedBrightness(t.specularColor),i=1-this._getMaxComponent(t.specularColor),a=e._SolveMetallic(r,o,i),s=t.diffuseColor.scale(i/(1-e._DielectricSpecular.r)/Math.max(1-a,e._Epsilon)),u=t.specularColor.subtract(e._DielectricSpecular.scale(1-a)).scale(1/Math.max(a,e._Epsilon)),l=n.Color3.Lerp(s,u,a*a);return{baseColor:l=l.clampToRef(0,1,l),metallic:a,roughness:1-t.glossiness}},e.prototype._getPerceivedBrightness=function(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0},e.prototype._getMaxComponent=function(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0},e.prototype._convertMetalRoughFactorsToMetallicRoughnessAsync=function(e,t,r,n){var o=[],i={baseColor:e.albedoColor,metallic:e.metallic,roughness:e.roughness};return n&&(e.albedoTexture&&o.push(this._exportTextureAsync(e.albedoTexture,t).then((function(e){e&&(r.baseColorTexture=e)}))),e.metallicTexture&&o.push(this._exportTextureAsync(e.metallicTexture,t).then((function(e){e&&(r.metallicRoughnessTexture=e)})))),Promise.all(o).then((function(){return i}))},e.prototype._getGLTFTextureSampler=function(e){var t=this._getGLTFTextureWrapModesSampler(e),r=e instanceof n.Texture?e.samplingMode:null;if(null!=r)switch(r){case n.Texture.LINEAR_LINEAR:t.magFilter=9729,t.minFilter=9729;break;case n.Texture.LINEAR_NEAREST:t.magFilter=9729,t.minFilter=9728;break;case n.Texture.NEAREST_LINEAR:t.magFilter=9728,t.minFilter=9729;break;case n.Texture.NEAREST_LINEAR_MIPLINEAR:t.magFilter=9728,t.minFilter=9987;break;case n.Texture.NEAREST_NEAREST:t.magFilter=9728,t.minFilter=9728;break;case n.Texture.NEAREST_LINEAR_MIPNEAREST:t.magFilter=9728,t.minFilter=9985;break;case n.Texture.LINEAR_NEAREST_MIPNEAREST:t.magFilter=9729,t.minFilter=9984;break;case n.Texture.LINEAR_NEAREST_MIPLINEAR:t.magFilter=9729,t.minFilter=9986;break;case n.Texture.NEAREST_NEAREST_MIPLINEAR:t.magFilter=9728,t.minFilter=9986;break;case n.Texture.LINEAR_LINEAR_MIPLINEAR:t.magFilter=9729,t.minFilter=9987;break;case n.Texture.LINEAR_LINEAR_MIPNEAREST:t.magFilter=9729,t.minFilter=9985;break;case n.Texture.NEAREST_NEAREST_MIPNEAREST:t.magFilter=9728,t.minFilter=9984}return t},e.prototype._getGLTFTextureWrapMode=function(e){switch(e){case n.Texture.WRAP_ADDRESSMODE:return 10497;case n.Texture.CLAMP_ADDRESSMODE:return 33071;case n.Texture.MIRROR_ADDRESSMODE:return 33648;default:return n.Tools.Error("Unsupported Texture Wrap Mode "+e+"!"),10497}},e.prototype._getGLTFTextureWrapModesSampler=function(e){var t=this._getGLTFTextureWrapMode(e instanceof n.Texture?e.wrapU:n.Texture.WRAP_ADDRESSMODE),r=this._getGLTFTextureWrapMode(e instanceof n.Texture?e.wrapV:n.Texture.WRAP_ADDRESSMODE);return 10497===t&&10497===r?{}:{wrapS:t,wrapT:r}},e.prototype._convertSpecGlossFactorsToMetallicRoughnessAsync=function(e,t,r,o){var i=this;return Promise.resolve().then((function(){var a=i._exporter._samplers,s=i._exporter._textures,u={diffuseColor:e.albedoColor||n.Color3.White(),specularColor:e.reflectivityColor||n.Color3.White(),glossiness:e.microSurface||1},l=null,c=i._getGLTFTextureSampler(e.albedoTexture);return null!=c.magFilter&&null!=c.minFilter&&null!=c.wrapS&&null!=c.wrapT&&(a.push(c),l=a.length-1),e.reflectivityTexture&&!e.useMicroSurfaceFromReflectivityMapAlpha?Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported"):(e.albedoTexture||e.reflectivityTexture)&&o?i._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(e.albedoTexture,e.reflectivityTexture,u,t).then((function(n){if(n.baseColorTextureBase64){var o=i._getTextureInfoFromBase64(n.baseColorTextureBase64,"bjsBaseColorTexture_"+s.length+".png",t,e.albedoTexture?e.albedoTexture.coordinatesIndex:null,l);o&&(r.baseColorTexture=o)}if(n.metallicRoughnessTextureBase64){var a=i._getTextureInfoFromBase64(n.metallicRoughnessTextureBase64,"bjsMetallicRoughnessTexture_"+s.length+".png",t,e.reflectivityTexture?e.reflectivityTexture.coordinatesIndex:null,l);a&&(r.metallicRoughnessTexture=a)}return n})):i._convertSpecularGlossinessToMetallicRoughness(u)}))},e.prototype._convertPBRMaterialAsync=function(e,t,r){var n=this,o={},i={name:e.name};return e.isMetallicWorkflow()?(e.albedoColor&&(o.baseColorFactor=[e.albedoColor.r,e.albedoColor.g,e.albedoColor.b,e.alpha]),this._convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,o,r).then((function(a){return n.setMetallicRoughnessPbrMaterial(a,e,i,o,t,r)}))):this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,o,r).then((function(a){return n.setMetallicRoughnessPbrMaterial(a,e,i,o,t,r)}))},e.prototype.setMetallicRoughnessPbrMaterial=function(t,r,o,i,a,s){var u=this._exporter._materialMap,l=this._exporter._materials,c=[];if(t){if(e._SetAlphaMode(o,r),e.FuzzyEquals(t.baseColor,n.Color3.White(),e._Epsilon)&&r.alpha>=e._Epsilon||(i.baseColorFactor=[t.baseColor.r,t.baseColor.g,t.baseColor.b,r.alpha]),null!=t.metallic&&1!==t.metallic&&(i.metallicFactor=t.metallic),null!=t.roughness&&1!==t.roughness&&(i.roughnessFactor=t.roughness),null==r.backFaceCulling||r.backFaceCulling||(r.twoSidedLighting||n.Tools.Warn(r.name+": Back-face culling enabled and two-sided lighting disabled is not supported in glTF."),o.doubleSided=!0),s){if(r.bumpTexture){var f=this._exportTextureAsync(r.bumpTexture,a).then((function(e){e&&(o.normalTexture=e,1!==r.bumpTexture.level&&(o.normalTexture.scale=r.bumpTexture.level))}));c.push(f)}if(r.ambientTexture){f=this._exportTextureAsync(r.ambientTexture,a).then((function(e){if(e){var t={index:e.index,texCoord:e.texCoord};o.occlusionTexture=t,r.ambientTextureStrength&&(t.strength=r.ambientTextureStrength)}}));c.push(f)}if(r.emissiveTexture){f=this._exportTextureAsync(r.emissiveTexture,a).then((function(e){e&&(o.emissiveTexture=e)}));c.push(f)}}e.FuzzyEquals(r.emissiveColor,n.Color3.Black(),e._Epsilon)||(o.emissiveFactor=r.emissiveColor.asArray()),o.pbrMetallicRoughness=i,l.push(o),u[r.uniqueId]=l.length-1}return this._finishMaterial(c,o,r,a)},e.prototype.getPixelsFromTexture=function(e){return e.textureType,n.Constants.TEXTURETYPE_UNSIGNED_INT,e.readPixels()},e.prototype._exportTextureAsync=function(e,t){var r=this,n=this._exporter._extensionsPreExportTextureAsync("exporter",e,t);return n?n.then((function(n){return n?r._exportTextureInfoAsync(n,t):r._exportTextureInfoAsync(e,t)})):this._exportTextureInfoAsync(e,t)},e.prototype._exportTextureInfoAsync=function(e,t){var r=this;return Promise.resolve().then((function(){var n=e.uid;if(n in r._textureMap)return r._textureMap[n];for(var o=r._exporter._samplers,i=r._getGLTFTextureSampler(e),a=null,s=null,u=0;u<o.length;++u){var l=o[u];if(l.minFilter===i.minFilter&&l.magFilter===i.magFilter&&l.wrapS===i.wrapS&&l.wrapT===i.wrapT){s=u;break}}null==s?(o.push(i),a=o.length-1):a=s;var c=r.getPixelsFromTexture(e),f=e.getSize();return r._createBase64FromCanvasAsync(c,f.width,f.height,t).then((function(o){var i=r._getTextureInfoFromBase64(o,e.name.replace(/\.\/|\/|\.\\|\\/g,"_"),t,e.coordinatesIndex,a);return i&&(r._textureMap[n]=i,r._exporter._extensionsPostExportTextures("linkTextureInfo",i,e)),i}))}))},e.prototype._getTextureInfoFromBase64=function(e,t,r,o,i){var a=this._exporter._textures,s=this._exporter._images,u=this._exporter._imageData,l=null,c={source:s.length,name:t};null!=i&&(c.sampler=i);for(var f=atob(e.split(",")[1]),h=new ArrayBuffer(f.length),p=new Uint8Array(h),d=0,m=f.length;d<m;++d)p[d]=f.charCodeAt(d);var g={data:p,mimeType:r},_="image/jpeg"===r?".jpeg":".png",x=t+_,y=x;if(x in u&&(x=t+"_"+n.Tools.RandomId()+_),u[x]=g,"image/jpeg"===r||"image/png"===r){var T={name:t,uri:x},v=null;for(d=0;d<s.length;++d)if(s[d].uri===y){v=d;break}null==v?(s.push(T),c.source=s.length-1):c.source=v,a.push(c),l={index:a.length-1},null!=o&&(l.texCoord=o)}else n.Tools.Error("Unsupported texture mime type "+r);return l},e._DielectricSpecular=new n.Color3(.04,.04,.04),e._MaxSpecularPower=1024,e._Epsilon=1e-6,e}()},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},,function(e,t,r){"use strict";r.r(t),function(e){var n=r(4),o=r(3),i=r(8),a=r(9),s=r(6);r.d(t,"__IGLTFExporterExtension",(function(){return n.__IGLTFExporterExtension})),r.d(t,"_GLTFAnimation",(function(){return s._GLTFAnimation})),r.d(t,"GLTFData",(function(){return s.GLTFData})),r.d(t,"_Exporter",(function(){return s._Exporter})),r.d(t,"_BinaryWriter",(function(){return s._BinaryWriter})),r.d(t,"__IGLTFExporterExtensionV2",(function(){return s.__IGLTFExporterExtensionV2})),r.d(t,"_GLTFMaterialExporter",(function(){return s._GLTFMaterialExporter})),r.d(t,"GLTF2Export",(function(){return s.GLTF2Export})),r.d(t,"_GLTFUtilities",(function(){return s._GLTFUtilities})),r.d(t,"KHR_texture_transform",(function(){return s.KHR_texture_transform})),r.d(t,"KHR_lights_punctual",(function(){return s.KHR_lights_punctual})),r.d(t,"KHR_materials_sheen",(function(){return s.KHR_materials_sheen}));var u=void 0!==e?e:"undefined"!=typeof window?window:void 0;if(void 0!==u){u.BABYLON=u.BABYLON||{};var l=u.BABYLON;l.GLTF2=l.GLTF2||{},l.GLTF2.Exporter=l.GLTF2.Exporter||{},l.GLTF2.Exporter.Extensions=l.GLTF2.Exporter.Extensions||{};var c=[];for(var f in n)l[f]=n[f],c.push(f);for(var f in o)l[f]=o[f],c.push(f);for(var f in i)l[f]=i[f],c.push(f);for(var f in a)l.GLTF2.Exporter.Extensions[f]=a[f],c.push(f);for(var f in s)c.indexOf(f)>-1||(l.GLTF2.Exporter[f]=s[f])}}.call(this,r(11))}])}));
>>>>>>> Stashed changes
